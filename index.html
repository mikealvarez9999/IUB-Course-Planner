<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>IUB Course Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- PWA: theme color (updated dynamically by JS when theme changes) -->
  <meta name="theme-color" content="#121821" />
  <!-- iOS PWA enhancements -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="manifest" href="manifest.webmanifest" />

  <link rel="stylesheet" href="styles.css" />
  
  <!-- One-click PDF (bundled: html2canvas + jsPDF) -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  
  <!-- Google Analytics (GA4) — unchanged, add your ID if you use GA -->
  <script>
    (function initGA() {
      const GA_ID = 'G-XXXXXXXXXX'; // TODO: replace with your GA4 Measurement ID
      if (GA_ID && GA_ID.startsWith('G-') && GA_ID !== 'G-XXXXXXXXXX') {
        const s = document.createElement('script');
        s.async = true;
        s.src = 'https://www.googletagmanager.com/gtag/js?id=' + GA_ID;
        document.head.appendChild(s);
        window.dataLayer = window.dataLayer || [];
        function gtag(){ dataLayer.push(arguments); }
        window.gtag = gtag;
        gtag('js', new Date());
        gtag('config', GA_ID, { send_page_view: true });
      }
    })();
  </script>
</head>
<body>
  <header id="appHeader">
    <div class="brand">
      <h1>IUB Course Planner</h1>
      <div class="sub">Created with curiosity by Raiyan Bin Rais</div>
    </div>
    <div class="spacer"></div>

    <!-- IRAS Auth UI -->
    <div id="authBox" class="auth-box">
      <!-- This button becomes "Course Refresh" after login -->
      <button id="btnIRASLoginHeader" class="btn small iras" type="button" title="Sign in with IRAS">IRAS Login</button>
      <div id="authInfo" class="auth-info" style="display:none;">
        <span id="authChip" class="auth-chip" title="Signed in"></span>
        <button id="btnIRASLogout" class="btn alt small" type="button">Logout</button>
      </div>
    </div>

    <!-- Theme toggle -->
    <button id="themeToggleBtn" class="theme-switch" aria-label="Toggle theme" title="Toggle theme">
      <span class="ts-icon ts-moon" aria-hidden="true">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 1 0 9.79 9.79z"></path>
        </svg>
      </span>
      <span class="ts-icon ts-sun" aria-hidden="true">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.79 1.8-1.79zM1 13h3v-2H1v2zm10 10h2v-3h-2v3zm9.83-3.16l-1.79-1.79-1.8 1.79 1.8 1.79 1.79-1.79zM20 11v2h3v-2h-3zM12 1h-2v3h2V1zm6.24 3.84l1.79-1.79-1.79-1.79-1.8 1.79 1.8 1.79zM12 6a6 6 0 100 12 6 6 0 000-12zM4.84 17.24l-1.79 1.79 1.79 1.79 1.79-1.79-1.79-1.79z"></path>
        </svg>
      </span>
      <span class="ts-knob" aria-hidden="true"></span>
    </button>
  </header>

  <div class="container">
    <!-- Left: courses -->
    <div class="panel courses" id="coursesPanel">
      <div class="body">
        <h2>Courses</h2>

        <!-- Mobile-only helper text -->
        <div class="mobile-hint mobile-only small">
          Course list is really long, I'd suggest searching for specific courses instead of scrolling down manually.
        </div>

        <!-- Top row: search + mobile Filters button -->
        <div class="toolbar">
          <input type="text" id="search" placeholder="Search course code/title/faculty" />
          <button class="btn" id="btnToggleFilters" aria-expanded="false" aria-controls="filtersWrap">Filters</button>
        </div>

        <!-- Filters row (desktop inline; mobile bottom sheet) -->
        <div id="filtersBackdrop" aria-hidden="true"></div>
        <div class="filtersWrap" id="filtersWrap">
          <select id="filterDay" aria-label="Filter by schedule">
            <option value="">All schedules</option>
            <option value="ST">ST (Sun–Tue)</option>
            <option value="MW">MW (Mon–Wed)</option>
            <option value="AR">AR (Sat–Thu)</option>
          </select>
          <select id="filterAvail" aria-label="Filter by availability">
            <option value="">Any availability</option>
            <option value="open">Open seats</option>
            <option value="full">Full</option>
          </select>

          <!-- Put Done first, IRAS/Refresh second (so button is right of Done on desktop) -->
          <button class="btn alt mobile-only" id="btnCloseFilters">Done</button>
          <!-- This button becomes "Course Refresh" after login on desktop -->
          <button id="btnIRASLoginDesk" class="btn iras" type="button" title="Sign in with IRAS" style="display:none;">IRAS Login</button>
        </div>

        <!-- Last refreshed (above the table/cards) + spinner + backup badge -->
        <div class="row" style="gap:8px; align-items:center; margin-top: 6px;">
          <div id="courseRefreshInfo" class="footnote" style="margin-top:0;"></div>
          <div id="loadingSpinner" class="loading" style="display:none;">
            <span class="spinner" aria-hidden="true"></span>
            <span class="small">Loading courses…</span>
          </div>
          <!-- Mini banner when showing server/LS backup -->
          <div id="backupBadge" class="pill small" style="display:none;">Showing last saved backup</div>
        </div>

        <div id="courseError" class="footnote" style="display:none; color:#ff4d4f;"></div>

        <!-- Desktop: table -->
        <div class="table-wrap" id="tableWrap">
          <table class="table" id="courseTable" role="table" aria-label="Courses">
            <!-- Static colgroup to control column widths -->
            <colgroup>
              <col class="col-course" />
              <col class="col-sec" />
              <col class="col-time" />
              <col class="col-faculty" />
              <col class="col-title" />
              <col class="col-seats" />
              <col class="col-actions" />
            </colgroup>
            <thead>
              <tr>
                <th>Course</th>
                <th>Sec</th>
                <th>Days/Time</th>
                <th>Faculty</th>
                <th>Title</th>
                <th class="right">Enrolled</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="courseTbody">
              <tr><td colspan="7" class="small">Loading courses…</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Mobile: cards -->
        <div class="cards" id="courseCards" aria-live="polite"></div>

        <div class="footnote">Course list can be shown from IRAS when you’re signed in. Plans you make are saved locally (temporarily, if you sign out they're gone). I'm currently working to make them stick to your account (will be in future updates, soon).</div>
      </div>
    </div>

    <!-- Right: plans + schedule -->
    <div class="panel" id="planPanel">
      <div class="body">
        <h2>Plans</h2>
        <div class="row" style="margin-bottom:8px">
          <div class="plans" id="plans"></div>
          <button class="btn plan new" id="btnQuickAddPlan" title="New plan">+ New Plan</button>
        </div>
        <div class="row" style="margin-bottom:8px">
          <input type="text" id="newPlanName" placeholder="New plan name (optional)" />
          <button class="btn accent" id="btnAddPlan">Add Plan</button>
          <button class="btn" id="btnRenamePlan">Rename</button>
          <button class="btn" id="btnDuplicatePlan">Duplicate</button>
          <button class="btn danger" id="btnDeletePlan">Delete</button>
        </div>

        <div style="border-top:1px solid var(--border); margin:10px 0"></div>

        <div class="legend">
          <div class="pill">A: Sat</div>
          <div class="pill">S: Sun</div>
          <div class="pill">M: Mon</div>
          <div class="pill">T: Tue</div>
          <div class="pill">W: Wed</div>
          <div class="pill">R: Thu</div>
        </div>

        <div class="plan-title" id="planTitle">Plan A</div>

        <!-- Mobile day tabs -->
        <div class="day-tabs" id="dayTabs" aria-label="Select day"></div>

        <!-- Desktop schedule grid -->
        <div class="schedule desktop" id="schedule"></div>

        <!-- Mobile schedule list -->
        <div class="m-schedule" id="mSchedule" style="display:none;"></div>

        <div style="margin-top:12px;">
          <div class="row" style="justify-content: space-between; gap:8px; flex-wrap: wrap;">
            <div class="small">Conflicts are prevented on add.</div>
            <div class="row" style="gap:8px;">
              <button class="btn" id="btnExportPlans" title="Download a PDF of all plans">Export all plans (PDF)</button>
              <button class="btn" id="btnClearActive">Clear active plan</button>
            </div>
          </div>
          <div class="section-list" id="planList" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

<style>
  /* Off-screen container for building the PDF content */
  #exportContainer {
    position: fixed;
    left: -99999px;
    top: 0;
    width: 794px; /* ~A4 width at 96dpi; html2pdf will scale/paginate */
    background: #ffffff;
    color: #000;
    padding: 16px;
    box-sizing: border-box;
    z-index: -1;
  }
  .export-plan {
    break-inside: avoid-page;
    page-break-inside: avoid;
    margin-bottom: 16px;
  }
  .export-plan h2 {
    margin: 0 0 8px 0;
    font-size: 18px;
  }
  /* Force a page break between plans for html2pdf.js */
  .html2pdf__page-break {
    height: 0;
    break-after: page;
    page-break-after: always;
  }
  /* Make sure schedule backgrounds are visible even if the site is in dark mode */
  @media (prefers-color-scheme: dark) {
    #exportContainer { background: #ffffff; color: #000; }
  }
</style>
  
<script>
  // ---------- Config ----------
  const DAY_KEYS = ['A','S','M','T','W','R']; // No Friday
  const DAY_NAME_MAP = { A:'Sat', S:'Sun', M:'Mon', T:'Tue', W:'Wed', R:'Thu' };
  const DAY_MAP = Object.fromEntries(DAY_KEYS.map((k,i)=>[k,i]));
  const STORAGE_THEME = 'iub-theme'; // plans no longer stored locally

  // IRAS auth + endpoints
  const IRAS_AUTH_KEY = 'iras-auth-v1';
  const IRAS_OFFERS_CACHE_PREFIX = 'iras-offers-';
  const IRAS_API_URL = 'https://iras-bridge.vercel.app/api/iras-offers';

  const BRIDGE_BASE = new URL(IRAS_API_URL).origin;

  // Plans API (bridge)
  const PLANS_API_LOAD = `${BRIDGE_BASE}/api/plans/latest`;
  const PLANS_API_SAVE = `${BRIDGE_BASE}/api/plans/save`;

  // Per-user course backup keys (kept for offers only)
  function getIrasBackupKey(studentId) { return `iub-courses-backup-${studentId}`; }
  function getIrasBackupTimeKey(studentId) { return `iub-courses-backup-time-${studentId}`; }

  // IUB discrete time slots
  const SLOTS = [
    { start: 8*60,        end: 9*60+30,  label: '08:00-09:30' },
    { start: 9*60+40,     end: 11*60+10, label: '09:40-11:10' },
    { start: 11*60+20,    end: 12*60+50, label: '11:20-12:50' },
    { start: 13*60,       end: 14*60+30, label: '13:00-14:30' },
    { start: 14*60+40,    end: 16*60+10, label: '14:40-16:10' },
    { start: 16*60+20,    end: 17*60+50, label: '16:20-17:50' },
  ];
  const SLOT_HEIGHT = 100;
  const HEADER_OFFSET = 24;
  const DAY_GROUPS = { ST: ['S','T'], MW: ['M','W'], AR: ['A','R'] };

  // ---------- State ----------
  let staticSections = [];  // per-user backup (courses)
  let irasSections = [];    // from IRAS API (courses)
  let plans = [];           // [{id,name,items:[sectionKey]}]
  let activePlanId = null;
  const sectionByKey = new Map();
  let activeMobileDay = 'S';
  const mql = window.matchMedia('(max-width: 768px)');
  let isMobile = mql.matches;
  let authPopup = null;
  let isLoadingCourses = false;
  let savePlansTimer = null;

  // ---------- Utilities ----------
  const $ = sel => document.querySelector(sel);
  function setLoading(loading) {
    isLoadingCourses = !!loading;
    const sp = $('#loadingSpinner');
    const headerBtn = $('#btnIRASLoginHeader');
    const deskBtn = $('#btnIRASLoginDesk');
    if (sp) sp.style.display = loading ? 'inline-flex' : 'none';
    if (headerBtn) headerBtn.disabled = loading;
    if (deskBtn) deskBtn.disabled = loading;
  }
  function minutesFromHHMM(s) {
    if (!s) return null;
    let t = String(s).trim();
    t = t.replace(/[^0-9]/g, '');
    if (t.length === 3) t = '0' + t;
    const m = t.match(/^(\d{2})(\d{2})$/);
    if (!m) return null;
    return parseInt(m[1],10)*60 + parseInt(m[2],10);
  }
  function parseDaysTime(str) {
    const src = (str || '').toString().trim();
    const m = src.match(/^([A-Z]+)\s*:?\s*(\d{3,4})\s*-\s*(\d{3,4})$/i);
    if (!m) return null;
    const rawDays = (m[1] || '').trim().toUpperCase();
    const dayCodes = rawDays.split('').filter(d => DAY_KEYS.includes(d));
    const start = minutesFromHHMM(m[2]);
    const end = minutesFromHHMM(m[3]);
    if (!dayCodes.length || start == null || end == null) return null;
    return { days: dayCodes, start, end, label: `${rawDays}: ${String(m[2]).padStart(4,'0')}-${String(m[3]).padStart(4,'0')}` };
  }
  function keyOf(sec) {
    // Stable key: course|section|DAYS:start-end — ignores faculty, uses numeric times
    // Example: CSE101|1|ST:580-670
    const days = (sec.timing?.days || []).join('');
    const start = sec.timing?.start ?? 0;
    const end = sec.timing?.end ?? 0;
    return `${sec.course}|${sec.section}|${days}:${start}-${end}`;
  }
  function legacyKeyOf(sec) {
    // Your previous key (kept for compatibility)
    return `${sec.course}|${sec.section}|${sec.timing?.label || ''}|${(sec.faculty || '').trim()}`;
  }
  function updateThemeMeta(theme) {
    const meta = document.querySelector('meta[name="theme-color"]');
    if (meta) meta.setAttribute('content', theme === 'light' ? '#ffffff' : '#121821');
  }
  function applyThemeOnLoad() {
    const saved = localStorage.getItem(STORAGE_THEME);
    const theme = saved === 'light' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', theme);
    updateThemeMeta(theme);
    syncThemeButton(theme);
  }
  function setTheme(isLight) {
    const theme = isLight ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem(STORAGE_THEME, theme);
    updateThemeMeta(theme);
    syncThemeButton(theme);
  }
  function syncThemeButton(theme) {
    const btn = $('#themeToggleBtn');
    if (!btn) return;
    const isLight = theme === 'light';
    btn.setAttribute('aria-label', isLight ? 'Switch to dark theme' : 'Switch to light theme');
  }
  function reindexAll() {
    sectionByKey.clear();
    const add = (sec) => {
      if (!sec) return;
      sectionByKey.set(keyOf(sec), sec);       // new stable key
      sectionByKey.set(legacyKeyOf(sec), sec); // legacy key still resolves
    };
    for (const sec of staticSections) add(sec);
    for (const sec of irasSections) add(sec);
  }
  function overlaps(a, b) { return a.start < b.end && b.start < a.end; }
  function findConflictingWith(items, candidate) {
    for (const s of items) {
      const daySet = new Set(s.timing.days);
      if (!candidate.timing.days.some(d => daySet.has(d))) continue;
      if (overlaps({start:s.timing.start, end:s.timing.end}, {start:candidate.timing.start, end:candidate.timing.end})) return s;
    }
    return null;
  }
  function showToast(msg) {
    const t = $('#toast'); t.textContent = msg; t.classList.add('show');
    clearTimeout(showToast._timer); showToast._timer = setTimeout(()=>t.classList.remove('show'), 2800);
  }
  function slotIndexFor(start, end) {
    for (let i=0;i<SLOTS.length;i++) if (SLOTS[i].start===start && SLOTS[i].end===end) return i;
    return -1;
  }
  function inDayGroup(sec, groupKey) {
    const group = DAY_GROUPS[groupKey]; if (!group) return true;
    return sec.timing.days.some(d => group.includes(d));
  }

  // ---------- IRAS Auth ----------
  function buildRedirectURI() {
    return window.location.origin + window.location.pathname;
  }
  function getIRASAuth() {
    try { return JSON.parse(localStorage.getItem(IRAS_AUTH_KEY) || 'null'); } catch { return null; }
  }
  function setIRASAuth(auth) {
    localStorage.setItem(IRAS_AUTH_KEY, JSON.stringify(auth));
  }
  function clearIRASAuth() {
    localStorage.removeItem(IRAS_AUTH_KEY);
  }
  function captureIRASAuthFromURL() {
    const url = new URL(window.location.href);
    const qp = url.searchParams;
    const token = qp.get('token');
    const studentId = qp.get('studentId');
    if (token && studentId) {
      const auth = {
        token,
        studentId,
        studentName: qp.get('studentName') || '',
        departmentName: qp.get('departmentName') || '',
        degreeName: qp.get('degreeName') || '',
        email: qp.get('email') || '',
        ts: Date.now()
      };
      if (window.opener && typeof window.opener.postMessage === 'function') {
        window.opener.postMessage({ type: 'IRAS_AUTH', payload: auth }, window.location.origin);
        window.close();
        return true;
      }
      setIRASAuth(auth);
      ['token','studentId','studentName','departmentName','degreeName','email'].forEach(k => qp.delete(k));
      history.replaceState({}, document.title, url.pathname + (qp.toString() ? '?' + qp.toString() : '') + url.hash);
      return true;
    }
    return false;
  }
  function openIRASPopup() {
    const redirect = buildRedirectURI();
    const url = `https://iras-auth.pages.dev/login?redirect_uri=${encodeURIComponent(redirect)}`;
    const w = 520, h = 640;
    const y = window.top.outerHeight / 2 + window.top.screenY - (h / 2);
    const x = window.top.outerWidth / 2 + window.top.screenX - (w / 2);
    authPopup = window.open(url, 'iras_login', `width=${w},height=${h},left=${x},top=${y},resizable=yes,scrollbars=yes`);
    if (!authPopup) window.location.href = url;
  }

  // ---------- Plans: server sync (no localStorage) ----------
  function ensureDefaultPlans() {
    if (!Array.isArray(plans) || plans.length === 0) {
      const id = 'p_' + Math.random().toString(36).slice(2);
      plans = [{ id, name: 'Plan A', items: [] }];
      activePlanId = id;
    } else if (!activePlanId) {
      activePlanId = plans[0].id;
    }
  }

  async function loadPlansFromServer() {
    const auth = getIRASAuth();
    if (!auth?.studentId || !auth?.token) { ensureDefaultPlans(); return; }
    try {
      const r = await fetch(PLANS_API_LOAD, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ studentId: auth.studentId, token: auth.token })
      });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const j = await r.json();
      const data = j?.data || {};
      if (Array.isArray(data.plans) && data.plans.length > 0) {
        plans = data.plans;
        activePlanId = data.activePlanId || data.plans[0]?.id || null;
      } else {
        // No saved plans yet — initialize default in-memory; will save on first change
        ensureDefaultPlans();
      }
    } catch (e) {
      console.warn('Plans load failed:', e);
      ensureDefaultPlans();
    }
  }

  async function savePlansToServer() {
    const auth = getIRASAuth();
    if (!auth?.studentId || !auth?.token) return; // not logged in — cannot save
    try {
      const r = await fetch(PLANS_API_SAVE, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ studentId: auth.studentId, token: auth.token, plans, activePlanId })
      });
      // Silent on success/failure — we keep UI snappy
      if (!r.ok) throw new Error('HTTP ' + r.status);
    } catch (e) {
      console.warn('Plans save failed:', e);
      showToast('Could not save your plans right now.');
    }
  }

  function saveAll() {
    // Debounced remote save
    clearTimeout(savePlansTimer);
    savePlansTimer = setTimeout(() => { savePlansToServer(); }, 500);
  }

  function resetPlansToDefault() {
    const id = 'p_' + Math.random().toString(36).slice(2);
    plans = [{ id, name: 'Plan A', items: [] }];
    activePlanId = id;
  }

  // ---------- Courses (IRAS) ----------
  // UPDATED: make logout visually clear immediately (and wipe in-memory plans)
  function logoutIRAS() {
    // Optional: flush any pending plan save (non-blocking)
    try { savePlansToServer(); } catch {}
    clearIRASAuth();

    // Clear IRAS in-memory data and reindex (so the list reflects logged-out state)
    irasSections = [];
    staticSections = [];           // <-- ADD THIS
    reindexAll();

    // Hide the chip right away and clear its text
    const info = document.getElementById('authInfo');
    const chip = document.getElementById('authChip');
    if (chip) chip.textContent = '';
    if (info) info.style.display = 'none';

    // Reset login buttons to "IRAS Login" immediately
    wireAuthButtons();

    // Clear the "Last refreshed" text
    const infoBox = document.getElementById('courseRefreshInfo');
    if (infoBox) infoBox.textContent = '';

    // Reset plans to a clean default so another user's plans aren't visible
    resetPlansToDefault();

    renderAll();
    showToast('Logged out.');
  }

  // Wire login/refresh buttons depending on auth and screen size
  function wireAuthButtons() {
    const auth = getIRASAuth();
    const headLogin = $('#btnIRASLoginHeader');
    const deskLogin = $('#btnIRASLoginDesk');

    if (!headLogin || !deskLogin) return;

    const isDesk = window.matchMedia('(min-width: 769px)').matches;

    if (auth?.studentId) {
      headLogin.textContent = 'Course Refresh';
      headLogin.title = 'Refresh your IRAS courses';
      headLogin.onclick = () => { refreshCourses(); };
      deskLogin.textContent = 'Course Refresh';
      deskLogin.title = 'Refresh your IRAS courses';
      deskLogin.onclick = () => { refreshCourses(); };

      headLogin.style.display = isDesk ? 'none' : '';
      deskLogin.style.display = isDesk ? '' : 'none';
    } else {
      headLogin.textContent = 'IRAS Login';
      headLogin.title = 'Sign in with IRAS';
      headLogin.onclick = () => { openIRASPopup(); };
      deskLogin.textContent = 'IRAS Login';
      deskLogin.title = 'Sign in with IRAS';
      deskLogin.onclick = () => { openIRASPopup(); };

      headLogin.style.display = isDesk ? 'none' : '';
      deskLogin.style.display = isDesk ? '' : 'none';
    }
  }

  function updateAuthUI() {
    const auth = getIRASAuth();
    const info = $('#authInfo');
    const chip = $('#authChip');

    if (auth?.studentId) {
      info.style.display = 'flex';
      chip.textContent = `${auth.studentName || 'Student'} (${auth.studentId})`;
    } else {
      info.style.display = 'none';
      if (chip) chip.textContent = '';
    }
    wireAuthButtons();
  }

  // Receive auth from popup
  window.addEventListener('message', async (event) => {
    if (event.origin !== window.location.origin) return;
    if (event.data && event.data.type === 'IRAS_AUTH') {
      try {
        const auth = event.data.payload;
        setIRASAuth(auth);
        updateAuthUI();         // wires buttons (so IRAS Login becomes Course Refresh)
        // Load plans first, then courses, then render
        await loadPlansFromServer().catch(()=>{});
        await loadSectionsFromIRAS().catch(()=>{});
        renderAll();
      } finally {
        try { if (authPopup && !authPopup.closed) authPopup.close(); } catch {}
      }
    }
  });
  // add once, near other event listeners
  window.addEventListener('beforeunload', () => {
    try { savePlansToServer(); } catch {}
  });

  // ---------- Backend load (per-user backup only) ----------
  function loadBackupForCurrentUser() {
    const auth = getIRASAuth();
    staticSections = [];
    if (auth?.studentId) {
      const backup = localStorage.getItem(getIrasBackupKey(auth.studentId));
      if (backup) {
        try { staticSections = JSON.parse(backup) || []; } catch {}
      }
    }
    reindexAll();
  }

  async function loadSectionsFromBackend() {
    loadBackupForCurrentUser();
    const tbody = $('#courseTbody');
    if (!staticSections.length && tbody) {
      tbody.innerHTML = '<tr><td colspan="7" class="small">No courses available.</td></tr>';
    }
  }

  // ---------- IRAS offers load ----------
  async function refreshCourses() {
    await loadSectionsFromIRAS().then(() => renderAll());
  }

  function setBackupBadge(show, text) {
    const badge = $('#backupBadge');
    if (!badge) return;
    badge.style.display = show ? 'inline-flex' : 'none';
    if (text) badge.textContent = text;
  }

  async function loadSectionsFromIRAS() {
    const auth = getIRASAuth();
    const errBox = document.getElementById('courseError');
  
    setBackupBadge(false);
    if (errBox) { errBox.style.display = 'none'; errBox.textContent = ''; }
  
    // Not authenticated → clear in-memory IRAS data and reindex
    if (!auth?.studentId || !auth?.token) {
      irasSections = [];
      reindexAll();
      if (typeof migratePlanItemsIfPossible === 'function') migratePlanItemsIfPossible();
      return;
    }
  
    setLoading(true);
    try {
      const response = await fetch(IRAS_API_URL, {
        method: 'POST',
        mode: 'cors',
        cache: 'no-store',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ studentId: auth.studentId, token: auth.token }),
      });
  
      if (!response.ok) throw new Error('HTTP ' + response.status);
      const raw = await response.json();
  
      // Back-compat:
      // - Old bridge: { success:true, data:{ eligibleOfferCourses:[...] } } (no "source")
      // - New bridge: { ok:true, source:'iras'|'backup'|'none', data:{ eligibleOfferCourses:[...] } }
      const offersRaw = (raw && raw.data && Array.isArray(raw.data.eligibleOfferCourses))
        ? raw.data.eligibleOfferCourses
        : [];
      let source = raw && raw.source ? raw.source : '';
  
      if (!source) {
        if (offersRaw.length > 0) source = 'iras';
        else if (raw?.success === true || raw?.ok === true) source = 'none';
      }
  
      if (source === 'iras' && offersRaw.length > 0) {
        // Fresh IRAS: map and persist local backup
        irasSections = offersRaw.map(mapIRASRow).filter(Boolean);
        localStorage.setItem(getIrasBackupKey(auth.studentId), JSON.stringify(irasSections));
        localStorage.setItem(getIrasBackupTimeKey(auth.studentId), new Date().toISOString());
        localStorage.setItem(IRAS_OFFERS_CACHE_PREFIX + auth.studentId, JSON.stringify(offersRaw));
  
        // Prefer IRAS list visibly; keep static mirror for unified indexing
        staticSections = [...irasSections];
        reindexAll();
        if (typeof migratePlanItemsIfPossible === 'function') migratePlanItemsIfPossible();
        setBackupBadge(false);
        return;
      }
  
      if (source === 'backup' && offersRaw.length > 0) {
        // Server backup still gets mapped and mirrored locally for offline
        irasSections = offersRaw.map(mapIRASRow).filter(Boolean);
        localStorage.setItem(getIrasBackupKey(auth.studentId), JSON.stringify(irasSections));
        localStorage.setItem(getIrasBackupTimeKey(auth.studentId), new Date().toISOString());
        localStorage.setItem(IRAS_OFFERS_CACHE_PREFIX + auth.studentId, JSON.stringify(offersRaw));
  
        staticSections = [...irasSections];
        reindexAll();
        if (typeof migratePlanItemsIfPossible === 'function') migratePlanItemsIfPossible();
        setBackupBadge(true, 'Showing last saved backup');
        return;
      }
  
      // No data from bridge → try per-user local backup
      const ls = localStorage.getItem(getIrasBackupKey(auth.studentId));
      if (ls) {
        try {
          const parsed = JSON.parse(ls) || [];
          if (Array.isArray(parsed) && parsed.length > 0) {
            irasSections = parsed;
            staticSections = [...irasSections];
            reindexAll();
            if (typeof migratePlanItemsIfPossible === 'function') migratePlanItemsIfPossible();
            setBackupBadge(true, 'Showing last saved backup');
            return;
          }
        } catch {}
      }
  
      // Nothing anywhere — show friendly message
      irasSections = [];
      reindexAll();
      if (typeof migratePlanItemsIfPossible === 'function') migratePlanItemsIfPossible();
      if (errBox) {
        errBox.textContent = (raw && raw.message)
          ? raw.message
          : 'No IRAS offers available and no backup found yet for this student.';
        errBox.style.display = 'block';
      }
      setBackupBadge(false);
    } catch (e) {
      console.warn('IRAS offers fetch failed:', e);
  
      // Network/other error → fallback to per-user local backup if available
      const studentId = getIRASAuth()?.studentId || '';
      const backup = studentId && localStorage.getItem(getIrasBackupKey(studentId));
      if (backup) {
        try {
          irasSections = JSON.parse(backup) || [];
          staticSections = [...irasSections];
          reindexAll();
          if (typeof migratePlanItemsIfPossible === 'function') migratePlanItemsIfPossible();
          setBackupBadge(true, 'Showing last saved backup');
        } catch {
          irasSections = [];
          reindexAll();
          if (typeof migratePlanItemsIfPossible === 'function') migratePlanItemsIfPossible();
          if (errBox) { errBox.textContent = 'Could not load courses.'; errBox.style.display = 'block'; }
          setBackupBadge(false);
        }
      } else {
        irasSections = [];
        reindexAll();
        if (typeof migratePlanItemsIfPossible === 'function') migratePlanItemsIfPossible();
        if (errBox) { errBox.textContent = 'Could not load courses.'; errBox.style.display = 'block'; }
        setBackupBadge(false);
      }
    } finally {
      setLoading(false);
    }
  }

  // Map IRAS row -> internal section object
  function mapIRASRow(c) {
    if (!c) return null;
    const course = c.courseId || 'UNKNOWN';
    const section = parseInt(c.section || 0, 10) || 0;
    const title = c.courseName || '';
    const faculty = c.facualtyName || c.facultyName || c.faculty || '';
    const timing = parseDaysTime(c.timeSlot || '');
    const capacity = parseInt(c.capacity || 0, 10) || 0;
    let enrolled = Number.isFinite(parseInt(c.enrolled, 10)) ? parseInt(c.enrolled, 10) : (capacity - (parseInt(c.vacancy || 0, 10) || 0));
    if (!Number.isFinite(enrolled)) enrolled = 0;
    const credits = parseInt(c.creditHour || 0, 10) || 0;
    return timing ? { course, section, title, faculty, timing, enrolled, capacity, credits, cat: 'IRAS' } : null;
  }

  // ---------- Rendering ----------
  function getActiveList() {
    if (irasSections.length > 0) return irasSections;
    if (staticSections.length > 0) return staticSections;
    return [];
  }

  function renderPlans() {
    const cont = $('#plans'); cont.innerHTML = '';
    ensureDefaultPlans();
    for (const p of plans) {
      const btn = document.createElement('button');
      btn.className = 'plan' + (p.id === activePlanId ? ' active' : '');
      btn.textContent = p.name;
      btn.onclick = () => { activePlanId = p.id; saveAll(); renderAll(); };
      cont.appendChild(btn);
    }
    const plan = plans.find(p => p.id === activePlanId);
    $('#planTitle').textContent = plan ? plan.name : '—';
  }

  function filteredSections() {
    const base = getActiveList();
    const q = ($('#search').value || '').toLowerCase();
    const groupFilter = $('#filterDay').value || '';
    const availFilter = $('#filterAvail').value || '';
    return base.filter(sec => {
      const hay = `${sec.course} ${sec.title} ${sec.faculty}`.toLowerCase();
      if (q && !hay.includes(q)) return false;
      if (groupFilter && !inDayGroup(sec, groupFilter)) return false;
      if (availFilter) {
        const full = sec.enrolled >= sec.capacity;
        if (availFilter === 'open' && full) return false;
        if (availFilter === 'full' && !full) return false;
      }
      return true;
    });
  }

  function renderCourseTableOrCards() {
    const list = filteredSections();
    const tbody = $('#courseTbody');
    const cards = $('#courseCards');
    const infoBox = $('#courseRefreshInfo');

    infoBox.textContent = '';
    const auth = getIRASAuth();
    if (auth?.studentId) {
      const time = localStorage.getItem(getIrasBackupTimeKey(auth.studentId));
      if (time) {
        const dt = new Date(time);
        infoBox.textContent = 'Last refreshed: ' + dt.toLocaleString();
      }
    }

    if (list.length === 0) {
      $('#tableWrap').style.display = isMobile ? 'none' : '';
      cards.style.display = isMobile ? 'grid' : 'none';
      if (!isMobile) {
        tbody.innerHTML = '<tr><td colspan="7" class="small">No courses to show yet. Sign in via IRAS or wait for data to load.</td></tr>';
      } else {
        cards.innerHTML = '<div class="small" style="padding:8px;">No courses to show yet.</div>';
      }
      return;
    }

    if (!isMobile) {
      $('#tableWrap').style.display = '';
      cards.style.display = 'none';
      tbody.innerHTML = '';
      const active = plans.find(p => p.id === activePlanId);

      for (const sec of list) {
        const tr = document.createElement('tr');
        const full = sec.enrolled >= sec.capacity;

        tr.innerHTML = `
          <td class="nowrap"><strong>${sec.course}</strong></td>
          <td>${sec.section}</td>
          <td><span class="tag">${sec.timing.label}</span></td>
          <td class="wrap"></td>
          <td class="wrap">${sec.title || ''}</td>
          <td class="right"><span class="avail ${full ? 'full' : 'ok'}">${sec.enrolled}/${sec.capacity}</span></td>
          <td class="actions"></td>
        `;
        tr.children[3].textContent = sec.faculty || '';

        const actions = tr.querySelector('.actions');
        const btnAdd = document.createElement('button');
        btnAdd.className = 'btn';
        btnAdd.textContent = 'Add To Plan';
        btnAdd.onclick = () => tryAddToPlan(sec, active);
        actions.appendChild(btnAdd);

        tbody.appendChild(tr);
      }
    } else {
      $('#tableWrap').style.display = 'none';
      cards.style.display = 'grid';
      cards.innerHTML = '';
      const active = plans.find(p => p.id === activePlanId);

      for (const sec of list) {
        const full = sec.enrolled >= sec.capacity;
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-top">
            <div class="card-title">${sec.course} • Sec ${sec.section}</div>
            <div class="tag">${sec.timing.label}</div>
          </div>
          <div class="card-sub">${sec.title || ''}</div>
          <div class="card-meta">
            <span class="small"><strong>Faculty:</strong> <span class="fac"></span></span>
            <span class="small"><strong>Enrolled:</strong> <span class="${full ? 'avail full' : 'avail ok'}">${sec.enrolled}/${sec.capacity}</span></span>
          </div>
          <div class="card-actions">
            <button class="btn">Add To Plan</button>
          </div>
        `;
        card.querySelector('.fac').textContent = sec.faculty || '';
        card.querySelector('.btn').onclick = () => tryAddToPlan(sec, active);
        cards.appendChild(card);
      }
    }
  }
  function migratePlanItemsIfPossible() {
    let changed = false;
    for (const p of (plans || [])) {
      if (!Array.isArray(p.items) || p.items.length === 0) continue;
      const newItems = [];
      const seen = new Set();
      for (const k of p.items) {
        const sec = sectionByKey.get(k);
        if (sec) {
          const nk = keyOf(sec);
          if (!seen.has(nk)) {
            newItems.push(nk);
            seen.add(nk);
          }
        } else {
          // keep the original if we can't resolve it yet (maybe offers not loaded)
          if (!seen.has(k)) {
            newItems.push(k);
            seen.add(k);
          }
        }
      }
      if (newItems.length !== p.items.length || newItems.some((v,i)=>v!==p.items[i])) {
        p.items = newItems;
        changed = true;
      }
    }
    if (changed) {
      // save to server (debounced by saveAll)
      saveAll();
    }
  }
  function tryAddToPlan(sec, active) {
    if (!active) { alert('Create and select a plan first.'); return; }
    const existingItems = active.items.map(k => sectionByKey.get(k)).filter(Boolean);
    if (existingItems.some(x => x.course === sec.course)) {
      alert(`You cannot choose two sections of the same course (${sec.course}). Remove the other section first.`);
      return;
    }
    const conflict = findConflictingWith(existingItems, sec);
    if (conflict) {
      alert(`Cannot add:\n${sec.course} Sec-${sec.section} (${sec.timing.label}) conflicts with\n${conflict.course} Sec-${conflict.section} (${conflict.timing.label}).`);
      return;
    }
    const k = keyOf(sec); // <-- stable key
    if (!active.items.includes(k)) active.items.push(k);
    saveAll(); renderAll();
  }

  function renderSchedule() {
    const sched = $('#schedule');
    const mSched = $('#mSchedule');
    const plan = plans.find(p => p.id === activePlanId);
    const items = (plan?.items || []).map(k => sectionByKey.get(k)).filter(Boolean);

    if (!isMobile) {
      $('#dayTabs').style.display = 'none';
      mSched.style.display = 'none';
      sched.style.display = 'block';
      sched.innerHTML = '';

      sched.style.height = (HEADER_OFFSET + SLOTS.length * SLOT_HEIGHT) + 'px';

      const slots = document.createElement('div');
      slots.className = 'slots';
      const slotsHeader = document.createElement('div');
      slotsHeader.className = 'slots-header';
      slots.appendChild(slotsHeader);
      for (let i=0;i<SLOTS.length;i++) {
        const row = document.createElement('div');
        row.className = 'slot';
        row.style.top = `${HEADER_OFFSET + i*SLOT_HEIGHT}px`;
        row.style.height = `${SLOT_HEIGHT}px`;
        row.textContent = SLOTS[i].label;
        slots.appendChild(row);
      }
      sched.appendChild(slots);

      const days = document.createElement('div');
      days.className = 'days';
      for (let d = 0; d < DAY_KEYS.length; d++) {
        const col = document.createElement('div');
        col.className = 'day-col';
        const header = document.createElement('div');
        header.className = 'day-header';
        const dk = DAY_KEYS[d];
        header.innerHTML = `<strong>${DAY_NAME_MAP[dk]}</strong>`;
        col.appendChild(header);
        for (let i=0;i<SLOTS.length;i++) {
          const line = document.createElement('div');
          line.style.position = 'absolute';
          line.style.left = '0'; line.style.right = '0';
          line.style.top = `${HEADER_OFFSET + i*SLOT_HEIGHT}px`;
          line.style.borderTop = '1px dashed var(--grid-line)';
          col.appendChild(line);
        }
        days.appendChild(col);
      }
      sched.appendChild(days);

      for (const sec of items) {
        const idx = slotIndexFor(sec.timing.start, sec.timing.end);
        const top = (idx >= 0 ? HEADER_OFFSET + idx * SLOT_HEIGHT + 6 : HEADER_OFFSET + 6);
        const height = (idx >= 0 ? SLOT_HEIGHT - 12 : SLOT_HEIGHT - 12);
        for (const d of sec.timing.days) {
          const dayIdx = DAY_MAP[d];
          const block = document.createElement('div');
          block.className = 'block';
          block.style.top = `${top}px`;
          block.style.height = `${height}px`;
          block.innerHTML = `
            <div><strong>${sec.course}</strong> Sec ${sec.section}</div>
            <div class="small">${sec.timing.label} • ${sec.title || ''}</div>
            <div class="small"></div>
          `;
          block.querySelector('.small:last-child').textContent = sec.faculty || '';
          const dayCol = sched.querySelector('.days').children[dayIdx];
          block.style.left = '6px';
          block.style.right = '6px';
          dayCol.appendChild(block);
        }
      }
    } else {
      $('#dayTabs').style.display = 'flex';
      sched.style.display = 'none';
      mSched.style.display = 'block';
      mSched.innerHTML = '';

      if (!DAY_KEYS.includes(activeMobileDay)) activeMobileDay = DAY_KEYS[0];

      const tabs = $('#dayTabs');
      tabs.innerHTML = '';
      for (const dk of DAY_KEYS) {
        const tab = document.createElement('button');
        tab.className = 'day-tab' + (dk === activeMobileDay ? ' active' : '');
        tab.textContent = DAY_NAME_MAP[dk];
        tab.onclick = () => { activeMobileDay = dk; renderSchedule(); };
        tabs.appendChild(tab);
      }

      for (let i=0; i<SLOTS.length; i++) {
        const slot = SLOTS[i];
        const row = document.createElement('div');
        row.className = 'm-slot';
        const label = document.createElement('div');
        label.className = 'm-slot-label';
        label.textContent = slot.label;
        row.appendChild(label);

        const inThisSlot = (items || []).filter(s =>
          s.timing.days.includes(activeMobileDay) &&
          s.timing.start === slot.start &&
          s.timing.end === slot.end
        );

        if (inThisSlot.length === 0) {
          const none = document.createElement('div');
          none.className = 'small';
          none.textContent = '—';
          row.appendChild(none);
        } else {
          for (const sec of inThisSlot) {
            const card = document.createElement('div');
            card.className = 'm-block';
            card.innerHTML = `
              <div><strong>${sec.course}</strong> Sec ${sec.section}</div>
              <div class="small">${sec.title || ''}</div>
              <div class="small"></div>
            `;
            card.querySelector('.small:last-child').textContent = sec.faculty || '';
            row.appendChild(card);
          }
        }

        mSched.appendChild(row);
      }
    }
  }

  function renderPlanList() {
    ensureDefaultPlans();
    const plan = plans.find(p => p.id === activePlanId);
    const items = (plan?.items || []).map(k => sectionByKey.get(k)).filter(Boolean);
    const list = $('#planList');
    list.innerHTML = '';
    for (const sec of items) {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="wrap">
          <strong>${sec.course}</strong> Sec ${sec.section}
          <span class="tag">${sec.timing.label}</span>
          <div class="small">${sec.title}</div>
          <div class="small"></div>
        </div>
      `;
      div.querySelector('.small:last-child').textContent = sec.faculty || '';
      const r = document.createElement('div');
      const btn = document.createElement('button');
      btn.className = 'btn danger';
      btn.textContent = 'Remove';
      btn.onclick = () => {
        const k = keyOf(sec);
        plan.items = plan.items.filter(x => x !== k);
        saveAll(); renderAll();
      };
      r.appendChild(btn);
      div.appendChild(r);
      list.appendChild(div);
    }
  }

  function renderAll() {
    updateAuthUI();
    renderPlans();
    renderCourseTableOrCards();
    renderSchedule();
    renderPlanList();
  }

  // ---------- Header compact behavior (mobile) ----------
  const headerEl = $('#appHeader');
  function updateHeaderCompact() {
    if (!headerEl) return;
    const shouldCompact = isMobile && window.scrollY > 20;
    headerEl.classList.toggle('compact', shouldCompact);
  }
  window.addEventListener('scroll', updateHeaderCompact, { passive: true });

  // ---------- Filters bottom sheet handlers (mobile) ----------
  function closeFiltersSheet() {
    const wrap = document.getElementById('filtersWrap');
    const bd = document.getElementById('filtersBackdrop');
    const btn = document.getElementById('btnToggleFilters');
    if (!wrap || !bd) return;
    wrap.classList.remove('open');
    bd.classList.remove('show');
    if (btn) btn.setAttribute('aria-expanded', 'false');
  }

  document.getElementById('btnToggleFilters').onclick = () => {
    const wrap = document.getElementById('filtersWrap');
    const bd = document.getElementById('filtersBackdrop');
    const open = !wrap.classList.contains('open');
    wrap.classList.toggle('open', open);
    bd.classList.toggle('show', open);
    document.getElementById('btnToggleFilters')
      .setAttribute('aria-expanded', open ? 'true' : 'false');
  };

  document.getElementById('filtersBackdrop').addEventListener('click', (e) => {
    const { clientX, clientY } = e;
    closeFiltersSheet();
    requestAnimationFrame(() => {
      const el = document.elementFromPoint(clientX, clientY);
      if (el && typeof el.click === 'function') el.click();
    });
  });

  document.getElementById('btnCloseFilters').onclick = () => closeFiltersSheet();

  document.getElementById('planPanel').addEventListener('pointerdown', () => closeFiltersSheet());

  // ---------- Events ----------
  $('#btnQuickAddPlan').onclick = () => {
    const id = 'p_' + Math.random().toString(36).slice(2);
    plans.push({ id, name: `Plan ${String.fromCharCode(65 + plans.length)}`, items: [] });
    activePlanId = id;
    saveAll(); renderAll();
    showToast('New plan created.');
  };

  $('#btnAddPlan').onclick = () => {
    const base = ($('#newPlanName').value || '').trim();
    const name = base || `Plan ${String.fromCharCode(65 + plans.length)}`;
    const id = 'p_' + Math.random().toString(36).slice(2);
    plans.push({ id, name, items: [] });
    activePlanId = id;
    $('#newPlanName').value = '';
    saveAll(); renderAll();
  };

  $('#btnRenamePlan').onclick = () => {
    const p = plans.find(x => x.id === activePlanId);
    if (!p) return showToast('No active plan.');
    const name = prompt('New name:', p.name);
    if (!name) return;
    p.name = name;
    saveAll(); renderAll();
  };

  $('#btnDuplicatePlan').onclick = () => {
    const p = plans.find(x => x.id === activePlanId);
    if (!p) return showToast('No active plan.');
    const id = 'p_' + Math.random().toString(36).slice(2);
    plans.push({ id, name: p.name + ' (copy)', items: [...p.items] });
    activePlanId = id;
    saveAll(); renderAll();
  };

  $('#btnDeletePlan').onclick = () => {
    const idx = plans.findIndex(x => x.id === activePlanId);
    if (idx < 0) return showToast('No active plan.');
    const ok = confirm(`Delete ${plans[idx].name}?`);
    if (!ok) return;
    plans.splice(idx, 1);
    activePlanId = plans[0]?.id || null;
    ensureDefaultPlans();
    saveAll(); renderAll();
  };

  $('#btnClearActive').onclick = () => {
    const p = plans.find(x => x.id === activePlanId);
    if (!p) return;
    p.items = [];
    saveAll(); renderAll();
  };

  $('#search').oninput = () => renderCourseTableOrCards();
  $('#filterDay').onchange = () => renderCourseTableOrCards();
  $('#filterAvail').onchange = () => renderCourseTableOrCards();

  // Theme toggle (switch)
  $('#themeToggleBtn').addEventListener('click', () => {
    const current = document.documentElement.getAttribute('data-theme') || 'dark';
    setTheme(current !== 'light');
  });

  // Logout button
  document.getElementById('btnIRASLogout').addEventListener('click', logoutIRAS);

  // Also re-wire auth buttons on resize breakpoint changes
  mql.addEventListener('change', e => {
    isMobile = e.matches;
    updateAuthUI();
    updateHeaderCompact();
    renderAll();
  });

  // ---------- Init ----------
  (function initApp() {
    applyThemeOnLoad();
  
    // Always have an in-memory default so UI renders immediately
    ensureDefaultPlans();
  
    // If this page is a redirect callback, capture auth and clean URL
    captureIRASAuthFromURL();
  
    // Show correct header buttons now
    updateAuthUI();
  
    // Kick off async loads without blocking/wedging the script
    loadPlansFromServer().then(() => { renderAll(); }).catch(()=>{ /* keep UI */ });
    loadSectionsFromBackend();   // local backup of courses (non-blocking)
  
    // First paint of the UI (empty/default), will update again when loads finish
    renderAll();
    updateHeaderCompact();
  })();
  // Export all plans to a single PDF (client-side only)
  async function exportAllPlansToPDF() {
    if (!window.html2pdf) {
      alert('Export library not loaded. Please reload the page and try again.');
      return;
    }
    if (!Array.isArray(plans) || plans.length === 0) {
      showToast('No plans to export.');
      return;
    }

    const btn = document.getElementById('btnExportPlans');
    if (btn) { btn.disabled = true; btn.textContent = 'Preparing PDF…'; }
    showToast('Preparing PDF…');

    // Create an off-screen container for clean export content
    let exportEl = document.getElementById('exportContainer');
    if (!exportEl) {
      exportEl = document.createElement('div');
      exportEl.id = 'exportContainer';
      document.body.appendChild(exportEl);
    }
    exportEl.innerHTML = '';

    // Keep current UI state to restore later
    const prevActive = activePlanId;
    const prevIsMobile = isMobile;

    try {
      // Force desktop-style schedule rendering for clearer PDF
      isMobile = false;

      // Build a section for each plan
      for (let i = 0; i < plans.length; i++) {
        const p = plans[i];
        activePlanId = p.id;

        // Re-render schedule and list for this plan in the main DOM
        // so we can clone the fully-styled result.
        if (typeof renderAll === 'function') renderAll();
        else {
          if (typeof renderSchedule === 'function') renderSchedule();
          if (typeof renderPlans === 'function') renderPlans();
          // If you have a dedicated function to render the right-side list, call it here too.
        }

        const sched = document.getElementById('schedule');
        const list = document.getElementById('planList');
        const title = document.getElementById('planTitle');

        // Build export section
        const section = document.createElement('section');
        section.className = 'export-plan';

        const h2 = document.createElement('h2');
        h2.textContent = (p.name || title?.textContent || 'Plan');
        section.appendChild(h2);

        // Clone the desktop schedule (grid)
        if (sched) {
          const schedClone = sched.cloneNode(true);
          // Ensure the clone is visible in export even if original is hidden by app logic
          schedClone.style.display = 'block';
          section.appendChild(schedClone);
        }

        // Clone the plan items list (chosen sections)
        if (list) {
          const listWrap = document.createElement('div');
          listWrap.style.marginTop = '8px';
          const listTitle = document.createElement('div');
          listTitle.className = 'small';
          listTitle.style.margin = '6px 0';
          listTitle.textContent = 'Selected sections';
          listWrap.appendChild(listTitle);

          const listClone = list.cloneNode(true);
          listWrap.appendChild(listClone);
          section.appendChild(listWrap);
        }

        exportEl.appendChild(section);

        // Add a page break between plans (not after the last one)
        if (i < plans.length - 1) {
          const br = document.createElement('div');
          br.className = 'html2pdf__page-break';
          exportEl.appendChild(br);
        }
      }

      // Restore the active plan in the main UI before generating PDF to avoid visible flicker
      activePlanId = prevActive;
      if (typeof renderAll === 'function') renderAll();

      // Set options (tuned for desktop and Android Chrome; iOS gets a lighter render)
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const now = new Date();
      const filename = `iub-plans-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.pdf`;

      const opt = {
        margin: 10,
        filename,
        image: { type: 'jpeg', quality: 0.95 },
        html2canvas: {
          scale: isIOS ? 1.5 : 2,  // iOS memory is tighter
          useCORS: true,
          logging: false,
          // Helps html2canvas size itself to the content width
          windowWidth: exportEl.scrollWidth
        },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css', 'legacy'] }
      };

      await html2pdf().set(opt).from(exportEl).save();
      showToast('PDF downloaded.');
    } catch (err) {
      console.error('Export failed:', err);
      alert('Could not generate the PDF. If this keeps happening, try on a desktop browser or use the Print route.');
    } finally {
      // Cleanup and restore UI
      if (btn) { btn.disabled = false; btn.textContent = 'Export all plans (PDF)'; }
      isMobile = prevIsMobile;
      activePlanId = prevActive;
      if (typeof renderAll === 'function') renderAll();
      // Keep the hidden exportEl for next time; or remove it if you prefer
      // exportEl.remove();
    }
  }

  // Wire the button (safe to call multiple times)
  (function wireExportButton() {
    const btn = document.getElementById('btnExportPlans');
    if (btn) btn.onclick = exportAllPlansToPDF;
  })();
</script>
</body>
</html>
