<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>IUB Course Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="theme-color" content="#121821" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="manifest" href="manifest.webmanifest" />

  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header id="appHeader">
    <div class="brand">
      <h1>IUB Course Planner</h1>
      <div class="sub">Created with curiosity by Raiyan Bin Rais</div>
    </div>
    <div class="spacer"></div>

    <button id="themeToggleBtn" class="theme-switch" aria-label="Toggle theme" title="Toggle theme">
      <span class="ts-icon ts-moon" aria-hidden="true">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 1 0 9.79 9.79z"></path>
        </svg>
      </span>
      <span class="ts-icon ts-sun" aria-hidden="true">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.79 1.8-1.79zM1 13h3v-2H1v2zm10 10h2v-3h-2v3zm9.83-3.16l-1.79-1.79-1.8 1.79 1.8 1.79 1.79-1.79zM20 11v2h3v-2h-3zM12 1h-2v3h2V1zm6.24 3.84l1.79-1.79-1.79-1.79-1.8 1.79 1.8 1.79zM12 6a6 6 0 100 12 6 6 0 000-12zM4.84 17.24l-1.79 1.79 1.79 1.79 1.79-1.79-1.79-1.79z"></path>
        </svg>
      </span>
      <span class="ts-knob" aria-hidden="true"></span>
    </button>
  </header>

  <div class="container">
    <!-- Left: courses -->
    <div class="panel courses" id="coursesPanel">
      <div class="body">
        <h2>Courses</h2>

        <div class="mobile-hint mobile-only small">
          Course list is really long, I'd suggest searching for specific courses instead of scrolling down manually.
        </div>

        <!-- Top row: search + Filters + Data source + IRAS auth -->
        <div class="toolbar">
          <input type="text" id="search" placeholder="Search course code/title/faculty" />
          <button class="btn" id="btnToggleFilters" aria-expanded="false" aria-controls="filtersWrap">Filters</button>

          <div class="sep"></div>

          <label class="small muted" for="dataSource">Source</label>
          <select id="dataSource" aria-label="Course source">
            <option value="static">Static list</option>
            <option value="iras" disabled>IRAS offers</option>
          </select>
          <button class="btn small" id="btnIrasAuth" title="Sign in to IRAS">Sign in with IRAS</button>
        </div>

        <!-- Filters row (desktop inline; mobile bottom sheet) -->
        <div id="filtersBackdrop" aria-hidden="true"></div>
        <div class="filtersWrap" id="filtersWrap">
          <select id="filterDay" aria-label="Filter by schedule">
            <option value="">All schedules</option>
            <option value="ST">ST (Sun–Tue)</option>
            <option value="MW">MW (Mon–Wed)</option>
            <option value="AR">AR (Sat–Thu)</option>
          </select>
          <select id="filterAvail" aria-label="Filter by availability">
            <option value="">Any availability</option>
            <option value="open">Open seats</option>
            <option value="full">Full</option>
          </select>
          <button class="btn alt mobile-only" id="btnCloseFilters">Done</button>
        </div>

        <div id="courseError" class="footnote" style="display:none; color:#ff4d4f;"></div>

        <!-- Desktop: table -->
        <div class="table-wrap" id="tableWrap">
          <table class="table" id="courseTable" role="table" aria-label="Courses">
            <colgroup>
              <col class="col-course" />
              <col class="col-sec" />
              <col class="col-time" />
              <col class="col-faculty" />
              <col class="col-title" />
              <col class="col-seats" />
              <col class="col-actions" />
            </colgroup>
            <thead>
              <tr>
                <th>Course</th>
                <th>Sec</th>
                <th>Days/Time</th>
                <th>Faculty</th>
                <th>Title</th>
                <th class="right">Seats</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="courseTbody">
              <tr><td colspan="7" class="small">Loading courses…</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Mobile: cards -->
        <div class="cards" id="courseCards" aria-live="polite"></div>

        <div class="footnote">Course list can come from IRAS (per-student) or the static list. Plans are saved locally in your browser.</div>
      </div>
    </div>

    <!-- Right: plans + schedule -->
    <div class="panel" id="planPanel">
      <div class="body">
        <h2>Plans</h2>
        <div class="row" style="margin-bottom:8px">
          <div class="plans" id="plans"></div>
          <button class="btn plan new" id="btnQuickAddPlan" title="New plan">+ New Plan</button>
        </div>
        <div class="row" style="margin-bottom:8px">
          <input type="text" id="newPlanName" placeholder="New plan name (optional)" />
          <button class="btn accent" id="btnAddPlan">Add Plan</button>
          <button class="btn" id="btnRenamePlan">Rename</button>
          <button class="btn" id="btnDuplicatePlan">Duplicate</button>
          <button class="btn danger" id="btnDeletePlan">Delete</button>
        </div>

        <div style="border-top:1px solid var(--border); margin:10px 0"></div>

        <div class="legend">
          <div class="pill">A: Sat</div>
          <div class="pill">S: Sun</div>
          <div class="pill">M: Mon</div>
          <div class="pill">T: Tue</div>
          <div class="pill">W: Wed</div>
          <div class="pill">R: Thu</div>
        </div>

        <div class="plan-title" id="planTitle">Plan A</div>

        <div class="day-tabs" id="dayTabs" aria-label="Select day"></div>

        <div class="schedule desktop" id="schedule"></div>
        <div class="m-schedule" id="mSchedule" style="display:none;"></div>

        <div style="margin-top:12px;">
          <div class="row" style="justify-content: space-between;">
            <div class="small">Conflicts are prevented on add.</div>
            <button class="btn" id="btnClearActive">Clear active plan</button>
          </div>
          <div class="section-list" id="planList" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

<script>
  // ---------- Config ----------
  const DAY_KEYS = ['A','S','M','T','W','R']; // No Friday
  const DAY_NAME_MAP = { A:'Sat', S:'Sun', M:'Mon', T:'Tue', W:'Wed', R:'Thu' };
  const DAY_MAP = Object.fromEntries(DAY_KEYS.map((k,i)=>[k,i]));
  const STORAGE_PLANS = 'iub-plans-v8';
  const STORAGE_THEME = 'iub-theme';

  // Auth + data source
  const STORAGE_AUTH = 'iub-iras-auth-v1';
  const AUTH_ORIGIN = 'https://iras-auth.pages.dev';
  const AUTH_URL = AUTH_ORIGIN + '/';
  const IRAS_API = 'https://irastools.pages.dev/api/student/all-offer-courses';
  const DATA_SOURCE_STATIC = 'static';
  const DATA_SOURCE_IRAS = 'iras';

  // IUB discrete time slots
  const SLOTS = [
    { start: 8*60,        end: 9*60+30,  label: '08:00-09:30' },
    { start: 9*60+40,     end: 11*60+10, label: '09:40-11:10' },
    { start: 11*60+20,    end: 12*60+50, label: '11:20-12:50' },
    { start: 13*60,       end: 14*60+30, label: '13:00-14:30' },
    { start: 14*60+40,    end: 16*60+10, label: '14:40-16:10' },
    { start: 16*60+20,    end: 17*60+50, label: '16:20-17:50' },
  ];
  const SLOT_HEIGHT = 100;
  const HEADER_OFFSET = 24;
  const DAY_GROUPS = { ST: ['S','T'], MW: ['M','W'], AR: ['A','R'] };

  // ---------- State ----------
  let sections = [];
  let plans = [];
  let activePlanId = null;
  const sectionByKey = new Map();
  let activeMobileDay = 'S';
  const mql = window.matchMedia('(max-width: 768px)');
  let isMobile = mql.matches;

  // Auth + source state
  let irasAuth = null; // { studentId, token, name?, expiresAt? }
  let dataSource = DATA_SOURCE_STATIC;

  // ---------- Utilities ----------
  const $ = sel => document.querySelector(sel);
  function minutesFromHHMM(s) {
    const m = (s||'').toString().trim().match(/^(\d{2})(\d{2})$/);
    if (!m) return null;
    return parseInt(m[1],10)*60 + parseInt(m[2],10);
  }
  function parseDaysTime(str) {
    const src = (str || '').trim();
    const m = src.match(/^([A-Z]+)\s*:\s*(\d{3,4})\s*-\s*(\d{3,4})$/i);
    if (!m) return null;
    const rawDays = (m[1] || '').trim().toUpperCase();
    const dayCodes = rawDays.split('').filter(d => DAY_KEYS.includes(d));
    const start = minutesFromHHMM(m[2]);
    const end = minutesFromHHMM(m[3]);
    if (!dayCodes.length || start == null || end == null) return null;
    return { days: dayCodes, start, end, label: `${rawDays}: ${m[2].trim()}-${m[3].trim()}` };
  }
  function keyOf(sec) {
    return `${sec.course}|${sec.section}|${sec.timing.label}|${(sec.faculty||'').trim()}`;
  }
  function saveAll() { localStorage.setItem(STORAGE_PLANS, JSON.stringify({ plans, activePlanId })); }
  function loadAll() {
    try {
      const p = JSON.parse(localStorage.getItem(STORAGE_PLANS) || '{}');
      if (Array.isArray(p.plans)) plans = p.plans;
      if (p.activePlanId) activePlanId = p.activePlanId;
    } catch {}
    if (!Array.isArray(plans) || plans.length === 0) {
      const id = 'p_' + Math.random().toString(36).slice(2);
      plans = [{ id, name: 'Plan A', items: [] }];
      activePlanId = id;
      saveAll();
    }
  }
  function showToast(msg) {
    const t = $('#toast'); t.textContent = msg; t.classList.add('show');
    clearTimeout(showToast._timer); showToast._timer = setTimeout(()=>t.classList.remove('show'), 2800);
  }
  function updateThemeMeta(theme) {
    const meta = document.querySelector('meta[name="theme-color"]');
    if (meta) meta.setAttribute('content', theme === 'light' ? '#ffffff' : '#121821');
  }
  function applyThemeOnLoad() {
    const saved = localStorage.getItem(STORAGE_THEME);
    const theme = saved === 'light' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', theme);
    updateThemeMeta(theme);
    syncThemeButton(theme);
  }
  function setTheme(isLight) {
    const theme = isLight ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem(STORAGE_THEME, theme);
    updateThemeMeta(theme);
    syncThemeButton(theme);
  }
  function syncThemeButton(theme) {
    const btn = $('#themeToggleBtn');
    if (!btn) return;
    const isLight = theme === 'light';
    btn.setAttribute('aria-label', isLight ? 'Switch to dark theme' : 'Switch to light theme');
  }
  function reindex() {
    sectionByKey.clear();
    for (const sec of sections) sectionByKey.set(keyOf(sec), sec);
  }
  function overlaps(a, b) { return a.start < b.end && b.start < a.end; }
  function findConflictingWith(items, candidate) {
    for (const s of items) {
      const daySet = new Set(s.timing.days);
      if (!candidate.timing.days.some(d => daySet.has(d))) continue;
      if (overlaps({start:s.timing.start, end:s.timing.end}, {start:candidate.timing.start, end:candidate.timing.end})) return s;
    }
    return null;
  }
  function seatStatus(sec) {
    const open = Math.max(sec.capacity - sec.enrolled, 0);
    return { open, full: open === 0 };
  }
  function slotIndexFor(start, end) {
    for (let i=0;i<SLOTS.length;i++) if (SLOTS[i].start===start && SLOTS[i].end===end) return i;
    return -1;
  }
  function inDayGroup(sec, groupKey) {
    const group = DAY_GROUPS[groupKey]; if (!group) return true;
    return sec.timing.days.some(d => group.includes(d));
  }

  // ---------- Static/Dynamic data loaders ----------
  async function loadStaticSections() {
    const tbody = $('#courseTbody'); const errorBox = $('#courseError');
    try {
      const resp = await fetch('data/courses.json', { cache: 'no-store' });
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const data = await resp.json();
      sections = (data || []).map(row => {
        const tParsed = parseDaysTime(row.days_time);
        if (!tParsed) return null;
        return {
          course: row.course || 'UNKNOWN',
          section: parseInt(row.section || '0', 10) || 0,
          title: row.title || '',
          faculty: (row.faculty || '').toString(),
          timing: tParsed,
          enrolled: parseInt(row.enrolled || '0', 10) || 0,
          capacity: parseInt(row.capacity || '0', 10) || 0,
          credits: parseInt(row.credits || '0', 10) || 0,
          cat: row.cat || ''
        };
      }).filter(Boolean);
      reindex(); errorBox.style.display = 'none';
    } catch (e) {
      sections = []; reindex();
      $('#courseError').textContent = 'Failed to load static course list.';
      $('#courseError').style.display = 'block';
    }
  }

  function normalizeHHMMAny(s) {
    if (!s) return null;
    const str = String(s).trim();
    // Accept "1120", "11:20", "11.20"
    const digits = str.replace(/[^\d]/g,'');
    if (digits.length === 3) return '0' + digits; // e.g., "920" -> "0920"
    if (digits.length === 4) return digits;
    return null;
  }

  function adaptIrasOfferToSection(o) {
    const course = o.course || o.course_code || o.courseCode || o.code || '';
    const section = parseInt(o.section || o.section_no || o.sectionNo || '0', 10) || 0;
    const title = o.title || o.course_title || o.courseTitle || '';
    const faculty = o.faculty || o.faculty_name || o.instructor || o.instructorName || o.teacher || '';

    // Build a Days/Time label compatible with parseDaysTime
    let label = o.days_time || o.daysTime || o.timeLabel || o.schedule || '';
    if (!label) {
      const grp = (o.group || o.daysGroup || o.days || '').toString().toUpperCase().replace(/[^A-Z]/g,'');
      const st = normalizeHHMMAny(o.start || o.startTime || o.timeStart);
      const en = normalizeHHMMAny(o.end || o.endTime || o.timeEnd);
      if (grp && st && en) label = `${grp}: ${st}-${en}`;
    }
    const tParsed = parseDaysTime(label);
    if (!tParsed) return null;

    const capacity = parseInt(o.capacity ?? o.cap ?? o.max ?? '0', 10) || 0;
    const enrolled = parseInt(o.enrolled ?? o.reg ?? o.current ?? '0', 10) || 0;
    const credits = parseInt(o.credits ?? o.credit ?? '0', 10) || 0;

    return { course, section, title, faculty, timing: tParsed, enrolled, capacity, credits, cat: o.cat || '' };
  }

  async function loadIrasSections() {
    const tbody = $('#courseTbody'); const errorBox = $('#courseError');
    if (!irasAuth?.token || !irasAuth?.studentId) {
      sections = []; reindex();
      errorBox.textContent = 'Sign in with IRAS to load your offers.';
      errorBox.style.display = 'block';
      return;
    }
    try {
      const resp = await fetch(IRAS_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        cache: 'no-store',
        body: JSON.stringify({ studentId: irasAuth.studentId, token: irasAuth.token }),
      });
      if (!resp.ok) {
        if (resp.status === 401 || resp.status === 403) {
          // Token invalid; sign out gracefully
          signOutIras(true);
          throw new Error('Unauthorized');
        }
        throw new Error('HTTP ' + resp.status);
      }
      const raw = await resp.json();
      const arr = Array.isArray(raw?.offers) ? raw.offers
                : Array.isArray(raw?.data) ? raw.data
                : Array.isArray(raw) ? raw
                : [];
      const mapped = arr.map(adaptIrasOfferToSection).filter(Boolean);
      sections = mapped;
      reindex(); errorBox.style.display = 'none';
      if (!mapped.length) {
        errorBox.textContent = 'No IRAS offers found for your account.';
        errorBox.style.display = 'block';
      }
    } catch (e) {
      sections = []; reindex();
      errorBox.textContent = 'Failed to load IRAS offers. Using Static list may work.';
      errorBox.style.display = 'block';
      console.warn('IRAS load failed:', e);
    }
  }

  async function refreshSections() {
    // Show loading
    const tbody = $('#courseTbody'); if (tbody) tbody.innerHTML = '<tr><td colspan="7" class="small">Loading courses…</td></tr>';
    if (dataSource === DATA_SOURCE_IRAS) await loadIrasSections();
    else await loadStaticSections();
    renderAll();
  }

  // ---------- Rendering (unchanged except they read from "sections") ----------
  function renderPlans() {
    const cont = $('#plans'); cont.innerHTML = '';
    for (const p of plans) {
      const btn = document.createElement('button');
      btn.className = 'plan' + (p.id === activePlanId ? ' active' : '');
      btn.textContent = p.name;
      btn.onclick = () => { activePlanId = p.id; saveAll(); renderAll(); };
      cont.appendChild(btn);
    }
    const plan = plans.find(p => p.id === activePlanId);
    $('#planTitle').textContent = plan ? plan.name : '—';
  }

  function filteredSections() {
    const q = ($('#search').value || '').toLowerCase();
    const groupFilter = $('#filterDay').value || '';
    const availFilter = $('#filterAvail').value || '';
    return sections.filter(sec => {
      const hay = `${sec.course} ${sec.title} ${sec.faculty}`.toLowerCase();
      if (q && !hay.includes(q)) return false;
      if (groupFilter && !inDayGroup(sec, groupFilter)) return false;
      if (availFilter) {
        const { full } = seatStatus(sec);
        if (availFilter === 'open' && full) return false;
        if (availFilter === 'full' && !full) return false;
      }
      return true;
    });
  }

  function renderCourseTableOrCards() {
    const list = filteredSections();
    const tbody = $('#courseTbody');
    const cards = $('#courseCards');

    if (!isMobile) {
      $('#tableWrap').style.display = '';
      cards.style.display = 'none';
      tbody.innerHTML = '';
      const active = plans.find(p => p.id === activePlanId);

      for (const sec of list) {
        const tr = document.createElement('tr');
        const { open, full } = seatStatus(sec);

        tr.innerHTML = `
          <td class="nowrap"><strong>${sec.course}</strong></td>
          <td>${sec.section}</td>
          <td><span class="tag">${sec.timing.label}</span></td>
          <td class="wrap"></td>
          <td class="wrap">${sec.title || ''}</td>
          <td class="right"><span class="avail ${full ? 'full' : 'ok'}">${open}/${sec.capacity}</span></td>
          <td class="actions"></td>
        `;
        tr.children[3].textContent = sec.faculty || '';

        const actions = tr.querySelector('.actions');
        const btnAdd = document.createElement('button');
        btnAdd.className = 'btn';
        btnAdd.textContent = 'Add to plan';
        btnAdd.onclick = () => tryAddToPlan(sec, active);
        actions.appendChild(btnAdd);

        tbody.appendChild(tr);
      }
    } else {
      $('#tableWrap').style.display = 'none';
      cards.style.display = 'grid';
      cards.innerHTML = '';
      const active = plans.find(p => p.id === activePlanId);

      for (const sec of list) {
        const { open, full } = seatStatus(sec);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-top">
            <div class="card-title">${sec.course} • Sec ${sec.section}</div>
            <div class="tag">${sec.timing.label}</div>
          </div>
          <div class="card-sub">${sec.title || ''}</div>
          <div class="card-meta">
            <span class="small"><strong>Faculty:</strong> <span class="fac"></span></span>
            <span class="small"><strong>Seats:</strong> <span class="${full ? 'avail full' : 'avail ok'}">${open}/${sec.capacity}</span></span>
          </div>
          <div class="card-actions">
            <button class="btn">Add to plan</button>
          </div>
        `;
        card.querySelector('.fac').textContent = sec.faculty || '';
        card.querySelector('.btn').onclick = () => tryAddToPlan(sec, active);
        cards.appendChild(card);
      }
    }
  }

  function tryAddToPlan(sec, active) {
    if (!active) return showToast('Create and select a plan first.');
    const existingItems = active.items.map(k => sectionByKey.get(k)).filter(Boolean);
    if (existingItems.some(x => x.course === sec.course)) {
      showToast(`You can't choose two sections of the same course (${sec.course}). Remove the other section first.`);
      return;
    }
    const conflict = findConflictingWith(existingItems, sec);
    if (conflict) {
      showToast(`Cannot add: ${sec.course} Sec-${sec.section} (${sec.timing.label}) conflicts with ${conflict.course} Sec-${conflict.section} (${conflict.timing.label}).`);
      return;
    }
    const k = keyOf(sec);
    if (!active.items.includes(k)) active.items.push(k);
    saveAll(); renderAll();
  }

  function renderSchedule() {
    const sched = $('#schedule');
    const mSched = $('#mSchedule');
    const plan = plans.find(p => p.id === activePlanId);
    const items = (plan?.items || []).map(k => sectionByKey.get(k)).filter(Boolean);

    if (!isMobile) {
      $('#dayTabs').style.display = 'none';
      mSched.style.display = 'none';
      sched.style.display = 'block';
      sched.innerHTML = '';

      sched.style.height = (HEADER_OFFSET + SLOTS.length * SLOT_HEIGHT) + 'px';

      const slots = document.createElement('div');
      slots.className = 'slots';
      const slotsHeader = document.createElement('div');
      slotsHeader.className = 'slots-header';
      slots.appendChild(slotsHeader);
      for (let i=0;i<SLOTS.length;i++) {
        const row = document.createElement('div');
        row.className = 'slot';
        row.style.top = `${HEADER_OFFSET + i*SLOT_HEIGHT}px`;
        row.style.height = `${SLOT_HEIGHT}px`;
        row.textContent = SLOTS[i].label;
        slots.appendChild(row);
      }
      sched.appendChild(slots);

      const days = document.createElement('div');
      days.className = 'days';
      for (let d = 0; d < DAY_KEYS.length; d++) {
        const col = document.createElement('div');
        col.className = 'day-col';
        const header = document.createElement('div');
        header.className = 'day-header';
        const dk = DAY_KEYS[d];
        header.innerHTML = `<strong>${DAY_NAME_MAP[dk]}</strong>`;
        col.appendChild(header);
        for (let i=0;i<SLOTS.length;i++) {
          const line = document.createElement('div');
          line.style.position = 'absolute';
          line.style.left = '0'; line.style.right = '0';
          line.style.top = `${HEADER_OFFSET + i*SLOT_HEIGHT}px`;
          line.style.borderTop = '1px dashed var(--grid-line)';
          col.appendChild(line);
        }
        days.appendChild(col);
      }
      sched.appendChild(days);

      for (const sec of items) {
        const idx = slotIndexFor(sec.timing.start, sec.timing.end);
        const top = (idx >= 0 ? HEADER_OFFSET + idx * SLOT_HEIGHT + 6 : HEADER_OFFSET + 6);
        const height = (idx >= 0 ? SLOT_HEIGHT - 12 : SLOT_HEIGHT - 12);
        for (const d of sec.timing.days) {
          const dayIdx = DAY_MAP[d];
          const block = document.createElement('div');
          block.className = 'block';
          block.style.top = `${top}px`;
          block.style.height = `${height}px`;
          block.innerHTML = `
            <div><strong>${sec.course}</strong> Sec ${sec.section}</div>
            <div class="small">${sec.timing.label} • ${sec.title || ''}</div>
            <div class="small"></div>
          `;
          block.querySelector('.small:last-child').textContent = sec.faculty || '';
          const dayCol = sched.querySelector('.days').children[dayIdx];
          block.style.left = '6px';
          block.style.right = '6px';
          dayCol.appendChild(block);
        }
      }
    } else {
      $('#dayTabs').style.display = 'flex';
      sched.style.display = 'none';
      mSched.style.display = 'block';
      mSched.innerHTML = '';

      if (!DAY_KEYS.includes(activeMobileDay)) activeMobileDay = DAY_KEYS[0];

      const tabs = $('#dayTabs');
      tabs.innerHTML = '';
      for (const dk of DAY_KEYS) {
        const tab = document.createElement('button');
        tab.className = 'day-tab' + (dk === activeMobileDay ? ' active' : '');
        tab.textContent = DAY_NAME_MAP[dk];
        tab.onclick = () => { activeMobileDay = dk; renderSchedule(); };
        tabs.appendChild(tab);
      }

      for (let i=0; i<SLOTS.length; i++) {
        const slot = SLOTS[i];
        const row = document.createElement('div');
        row.className = 'm-slot';
        const label = document.createElement('div');
        label.className = 'm-slot-label';
        label.textContent = slot.label;
        row.appendChild(label);

        const inThisSlot = items.filter(s =>
          s.timing.days.includes(activeMobileDay) &&
          s.timing.start === slot.start &&
          s.timing.end === slot.end
        );

        if (inThisSlot.length === 0) {
          const none = document.createElement('div');
          none.className = 'small';
          none.textContent = '—';
          row.appendChild(none);
        } else {
          for (const sec of inThisSlot) {
            const card = document.createElement('div');
            card.className = 'm-block';
            card.innerHTML = `
              <div><strong>${sec.course}</strong> Sec ${sec.section}</div>
              <div class="small">${sec.title || ''}</div>
              <div class="small"></div>
            `;
            card.querySelector('.small:last-child').textContent = sec.faculty || '';
            row.appendChild(card);
          }
        }

        mSched.appendChild(row);
      }
    }
  }

  function renderPlanList() {
    const plan = plans.find(p => p.id === activePlanId);
    const items = (plan?.items || []).map(k => sectionByKey.get(k)).filter(Boolean);
    const list = $('#planList');
    list.innerHTML = '';
    for (const sec of items) {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="wrap">
          <strong>${sec.course}</strong> Sec ${sec.section}
          <span class="tag">${sec.timing.label}</span>
          <div class="small">${sec.title}</div>
          <div class="small"></div>
        </div>
      `;
      div.querySelector('.small:last-child').textContent = sec.faculty || '';
      const r = document.createElement('div');
      const btn = document.createElement('button');
      btn.className = 'btn danger';
      btn.textContent = 'Remove';
      btn.onclick = () => {
        const k = keyOf(sec);
        plan.items = plan.items.filter(x => x !== k);
        saveAll(); renderAll();
      };
      r.appendChild(btn);
      div.appendChild(r);
      list.appendChild(div);
    }
  }

  function renderAll() {
    renderPlans();
    renderCourseTableOrCards();
    renderSchedule();
    renderPlanList();
  }

  // ---------- Header compact behavior (mobile) ----------
  const headerEl = $('#appHeader');
  function updateHeaderCompact() {
    if (!headerEl) return;
    const shouldCompact = isMobile && window.scrollY > 20;
    headerEl.classList.toggle('compact', shouldCompact);
  }
  window.addEventListener('scroll', updateHeaderCompact, { passive: true });

  // ---------- Filters bottom sheet handlers (mobile) ----------
  function closeFiltersSheet() {
    const wrap = document.getElementById('filtersWrap');
    const bd = document.getElementById('filtersBackdrop');
    const btn = document.getElementById('btnToggleFilters');
    if (!wrap || !bd) return;
    wrap.classList.remove('open');
    bd.classList.remove('show');
    if (btn) btn.setAttribute('aria-expanded', 'false');
  }

  document.getElementById('btnToggleFilters').onclick = () => {
    const wrap = document.getElementById('filtersWrap');
    const bd = document.getElementById('filtersBackdrop');
    const open = !wrap.classList.contains('open');
    wrap.classList.toggle('open', open);
    bd.classList.toggle('show', open);
    document.getElementById('btnToggleFilters')
      .setAttribute('aria-expanded', open ? 'true' : 'false');
  };

  document.getElementById('filtersBackdrop').addEventListener('click', (e) => {
    const { clientX, clientY } = e;
    closeFiltersSheet();
    requestAnimationFrame(() => {
      const el = document.elementFromPoint(clientX, clientY);
      if (el && typeof el.click === 'function') el.click();
    });
  });

  document.getElementById('btnCloseFilters').onclick = () => closeFiltersSheet();
  document.getElementById('planPanel').addEventListener('pointerdown', () => closeFiltersSheet());

  // ---------- Plans actions ----------
  $('#btnQuickAddPlan').onclick = () => {
    const id = 'p_' + Math.random().toString(36).slice(2);
    plans.push({ id, name: `Plan ${String.fromCharCode(65 + plans.length)}`, items: [] });
    activePlanId = id;
    saveAll(); renderAll();
    showToast('New plan created.');
  };

  $('#btnAddPlan').onclick = () => {
    const base = ($('#newPlanName').value || '').trim();
    const name = base || `Plan ${String.fromCharCode(65 + plans.length)}`;
    const id = 'p_' + Math.random().toString(36).slice(2);
    plans.push({ id, name, items: [] });
    activePlanId = id;
    $('#newPlanName').value = '';
    saveAll(); renderAll();
  };

  $('#btnRenamePlan').onclick = () => {
    const p = plans.find(x => x.id === activePlanId);
    if (!p) return showToast('No active plan.');
    const name = prompt('New name:', p.name);
    if (!name) return;
    p.name = name;
    saveAll(); renderAll();
  };

  $('#btnDuplicatePlan').onclick = () => {
    const p = plans.find(x => x.id === activePlanId);
    if (!p) return showToast('No active plan.');
    const id = 'p_' + Math.random().toString(36).slice(2);
    plans.push({ id, name: p.name + ' (copy)', items: [...p.items] });
    activePlanId = id;
    saveAll(); renderAll();
  };

  $('#btnDeletePlan').onclick = () => {
    const idx = plans.findIndex(x => x.id === activePlanId);
    if (idx < 0) return showToast('No active plan.');
    const ok = confirm(`Delete ${plans[idx].name}?`);
    if (!ok) return;
    plans.splice(idx, 1);
    activePlanId = plans[0]?.id || null;
    saveAll(); renderAll();
  };

  $('#btnClearActive').onclick = () => {
    const p = plans.find(x => x.id === activePlanId);
    if (!p) return;
    p.items = [];
    saveAll(); renderAll();
  };

  // ---------- Search/filters ----------
  $('#search').oninput = () => renderCourseTableOrCards();
  $('#filterDay').onchange = () => renderCourseTableOrCards();
  $('#filterAvail').onchange = () => renderCourseTableOrCards();

  // ---------- Theme ----------
  $('#themeToggleBtn').addEventListener('click', () => {
    const current = document.documentElement.getAttribute('data-theme') || 'dark';
    setTheme(current !== 'light');
  });

  // ---------- IRAS Auth + Source ----------
  function saveAuth() {
    if (irasAuth) localStorage.setItem(STORAGE_AUTH, JSON.stringify(irasAuth));
    else localStorage.removeItem(STORAGE_AUTH);
  }
  function loadAuth() {
    try { irasAuth = JSON.parse(localStorage.getItem(STORAGE_AUTH) || 'null'); } catch { irasAuth = null; }
  }
  function updateAuthUI() {
    const srcSel = $('#dataSource');
    const btn = $('#btnIrasAuth');
    const hasAuth = !!(irasAuth && irasAuth.token && irasAuth.studentId);
    // Enable/disable IRAS option
    const irasOpt = Array.from(srcSel.options).find(o => o.value === 'iras');
    if (irasOpt) irasOpt.disabled = !hasAuth;
    // If currently on IRAS but lost auth, switch to static
    if (!hasAuth && dataSource === DATA_SOURCE_IRAS) {
      dataSource = DATA_SOURCE_STATIC;
      srcSel.value = 'static';
    }
    // Button text
    btn.textContent = hasAuth ? `Sign out (${irasAuth.name || irasAuth.studentId})` : 'Sign in with IRAS';
    btn.title = hasAuth ? 'Sign out of IRAS' : 'Sign in to IRAS';
  }

  function signOutIras(silent=false) {
    irasAuth = null;
    saveAuth();
    updateAuthUI();
    if (dataSource === DATA_SOURCE_IRAS) {
      dataSource = DATA_SOURCE_STATIC;
      $('#dataSource').value = 'static';
      refreshSections();
    }
    if (!silent) showToast('Signed out of IRAS.');
  }

  function signInIras() {
    // Popup-based auth; provider should postMessage back { type:'IRAS_AUTH_SUCCESS', token, studentId, name? }
    const w = window.open(AUTH_URL + '?origin=' + encodeURIComponent(location.origin), 'irasAuth', 'width=460,height=640');
    if (!w) { showToast('Please allow popups to sign in.'); return; }

    function onMsg(event) {
      if (event.origin !== AUTH_ORIGIN) return;
      const d = event.data || {};
      if (d.type === 'IRAS_AUTH_SUCCESS' || d.type === 'IRAS_AUTH') {
        irasAuth = { token: d.token, studentId: d.studentId, name: d.name || d.displayName || '', expiresAt: d.expiresAt || null };
        saveAuth();
        updateAuthUI();
        dataSource = DATA_SOURCE_IRAS;
        $('#dataSource').value = 'iras';
        showToast('Signed in with IRAS.');
        refreshSections();
        window.removeEventListener('message', onMsg);
        try { w.close(); } catch {}
      } else if (d.type === 'IRAS_AUTH_FAILURE') {
        showToast('IRAS sign-in failed.');
        window.removeEventListener('message', onMsg);
        try { w.close(); } catch {}
      }
    }
    window.addEventListener('message', onMsg);
  }

  $('#btnIrasAuth').onclick = () => {
    if (irasAuth?.token) signOutIras();
    else signInIras();
  };

  $('#dataSource').onchange = () => {
    dataSource = ($('#dataSource').value === 'iras' ? DATA_SOURCE_IRAS : DATA_SOURCE_STATIC);
    refreshSections();
  };

  // ---------- PWA SW registration ----------
  (function registerSW() {
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          await navigator.serviceWorker.register('./sw.js');
          navigator.serviceWorker.addEventListener('controllerchange', () => window.location.reload());
        } catch (e) {
          console.warn('SW registration failed:', e);
        }
      });
    }
  })();

  // Mobile breakpoint watcher
  mql.addEventListener('change', e => {
    isMobile = e.matches;
    updateHeaderCompact();
    renderAll();
  });

  // ---------- Init ----------
  applyThemeOnLoad();
  loadAll();
  loadAuth();
  updateAuthUI();
  // Default to static; if already signed in, you can auto-switch to IRAS by uncommenting:
  if (irasAuth?.token) { dataSource = DATA_SOURCE_IRAS; $('#dataSource').value = 'iras'; }
  refreshSections();
</script>
</body>
</html>
