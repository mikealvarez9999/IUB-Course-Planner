<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>IUB Course Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA: theme color (updated dynamically by JS when theme changes) -->
  <meta name="theme-color" content="#121821" />
  <!-- iOS PWA enhancements -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="manifest" href="manifest.webmanifest" />

  <link rel="stylesheet" href="styles.css" />

  <!-- Google Analytics (GA4) — unchanged, add your ID if you use GA -->
  <script>
    (function initGA() {
      const GA_ID = 'G-XXXXXXXXXX'; // TODO: replace with your GA4 Measurement ID
      if (GA_ID && GA_ID.startsWith('G-') && GA_ID !== 'G-XXXXXXXXXX') {
        const s = document.createElement('script');
        s.async = true;
        s.src = 'https://www.googletagmanager.com/gtag/js?id=' + GA_ID;
        document.head.appendChild(s);
        window.dataLayer = window.dataLayer || [];
        function gtag(){ dataLayer.push(arguments); }
        window.gtag = gtag;
        gtag('js', new Date());
        gtag('config', GA_ID, { send_page_view: true });
      }
    })();
  </script>
</head>
<body>
  <header id="appHeader">
    <div class="brand">
      <h1>IUB Course Planner</h1>
      <div class="sub">Created with curiosity by Raiyan Bin Rais</div>
    </div>
    <div class="spacer"></div>

    <!-- IRAS Auth UI -->
    <div id="authBox" class="auth-box">
      <!-- This login button is shown on mobile; hidden on desktop -->
      <button id="btnIRASLoginHeader" class="btn small iras" type="button" title="Sign in with IRAS">IRAS Login</button>
      <div id="authInfo" class="auth-info" style="display:none;">
        <span id="authChip" class="auth-chip" title="Signed in"></span>
        <button id="btnIRASLogout" class="btn alt small" type="button">Logout</button>
      </div>
    </div>

    <!-- Theme toggle -->
    <button id="themeToggleBtn" class="theme-switch" aria-label="Toggle theme" title="Toggle theme">
      <span class="ts-icon ts-moon" aria-hidden="true">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 1 0 9.79 9.79z"></path>
        </svg>
      </span>
      <span class="ts-icon ts-sun" aria-hidden="true">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.79 1.8-1.79zM1 13h3v-2H1v2zm10 10h2v-3h-2v3zm9.83-3.16l-1.79-1.79-1.8 1.79 1.8 1.79 1.79-1.79zM20 11v2h3v-2h-3zM12 1h-2v3h2V1zm6.24 3.84l1.79-1.79-1.79-1.79-1.8 1.79 1.8 1.79zM12 6a6 6 0 100 12 6 6 0 000-12zM4.84 17.24l-1.79 1.79 1.79 1.79 1.79-1.79-1.79-1.79z"></path>
        </svg>
      </span>
      <span class="ts-knob" aria-hidden="true"></span>
    </button>
  </header>

  <div class="container">
    <!-- Left: courses -->
    <div class="panel courses" id="coursesPanel">
      <div class="body">
        <h2>Courses</h2>

        <!-- Mobile-only helper text -->
        <div class="mobile-hint mobile-only small">
          Course list is really long, I'd suggest searching for specific courses instead of scrolling down manually.
        </div>

        <!-- Top row: search + mobile Filters button -->
        <div class="toolbar">
          <input type="text" id="search" placeholder="Search course code/title/faculty" />
          <button class="btn" id="btnToggleFilters" aria-expanded="false" aria-controls="filtersWrap">Filters</button>
        </div>

        <!-- Data source toggle -->
        <div id="sourceToggle" class="source-toggle" style="display:none;">
          <span class="label">Source:</span>
          <label class="pill-option">
            <input type="radio" name="src" value="iras" id="srcIras" />
            <span>My IRAS offers</span>
          </label>
          <label class="pill-option">
            <input type="radio" name="src" value="static" id="srcStatic" />
            <span>Static list</span>
          </label>
        </div>

        <!-- Filters row (desktop inline; mobile bottom sheet) -->
        <div id="filtersBackdrop" aria-hidden="true"></div>
        <div class="filtersWrap" id="filtersWrap">
          <select id="filterDay" aria-label="Filter by schedule">
            <option value="">All schedules</option>
            <option value="ST">ST (Sun–Tue)</option>
            <option value="MW">MW (Mon–Wed)</option>
            <option value="AR">AR (Sat–Thu)</option>
          </select>
          <select id="filterAvail" aria-label="Filter by availability">
            <option value="">Any availability</option>
            <option value="open">Open seats</option>
            <option value="full">Full</option>
          </select>

          <!-- Desktop placement of IRAS Login (hidden on mobile) -->
          <button id="btnIRASLoginDesk" class="btn iras" type="button" title="Sign in with IRAS" style="display:none;">IRAS Login</button>

          <button class="btn alt mobile-only" id="btnCloseFilters">Done</button>
        </div>

        <div id="courseError" class="footnote" style="display:none; color:#ff4d4f;"></div>

        <!-- Desktop: table -->
        <div class="table-wrap" id="tableWrap">
          <table class="table" id="courseTable" role="table" aria-label="Courses">
            <!-- Static colgroup to control column widths -->
            <colgroup>
              <col class="col-course" />
              <col class="col-sec" />
              <col class="col-time" />
              <col class="col-faculty" />
              <col class="col-title" />
              <col class="col-seats" />
              <col class="col-actions" />
            </colgroup>
            <thead>
              <tr>
                <th>Course</th>
                <th>Sec</th>
                <th>Days/Time</th>
                <th>Faculty</th>
                <th>Title</th>
                <th class="right">Seats</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="courseTbody">
              <tr><td colspan="7" class="small">Loading courses…</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Mobile: cards -->
        <div class="cards" id="courseCards" aria-live="polite"></div>

        <div class="footnote">Course list can be shown from IRAS when you’re signed in. Plans you make are saved locally in your browser.</div>
      </div>
    </div>

    <!-- Right: plans + schedule -->
    <div class="panel" id="planPanel">
      <div class="body">
        <h2>Plans</h2>
        <div class="row" style="margin-bottom:8px">
          <div class="plans" id="plans"></div>
          <button class="btn plan new" id="btnQuickAddPlan" title="New plan">+ New Plan</button>
        </div>
        <div class="row" style="margin-bottom:8px">
          <input type="text" id="newPlanName" placeholder="New plan name (optional)" />
          <button class="btn accent" id="btnAddPlan">Add Plan</button>
          <button class="btn" id="btnRenamePlan">Rename</button>
          <button class="btn" id="btnDuplicatePlan">Duplicate</button>
          <button class="btn danger" id="btnDeletePlan">Delete</button>
        </div>

        <div style="border-top:1px solid var(--border); margin:10px 0"></div>

        <div class="legend">
          <div class="pill">A: Sat</div>
          <div class="pill">S: Sun</div>
          <div class="pill">M: Mon</div>
          <div class="pill">T: Tue</div>
          <div class="pill">W: Wed</div>
          <div class="pill">R: Thu</div>
        </div>

        <div class="plan-title" id="planTitle">Plan A</div>

        <!-- Mobile day tabs -->
        <div class="day-tabs" id="dayTabs" aria-label="Select day"></div>

        <!-- Desktop schedule grid -->
        <div class="schedule desktop" id="schedule"></div>

        <!-- Mobile schedule list -->
        <div class="m-schedule" id="mSchedule" style="display:none;"></div>

        <div style="margin-top:12px;">
          <div class="row" style="justify-content: space-between;">
            <div class="small">Conflicts are prevented on add.</div>
            <button class="btn" id="btnClearActive">Clear active plan</button>
          </div>
          <div class="section-list" id="planList" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

<script>
  // ---------- Config ----------
  const DAY_KEYS = ['A','S','M','T','W','R']; // No Friday
  const DAY_NAME_MAP = { A:'Sat', S:'Sun', M:'Mon', T:'Tue', W:'Wed', R:'Thu' };
  const DAY_MAP = Object.fromEntries(DAY_KEYS.map((k,i)=>[k,i]));
  const STORAGE_PLANS = 'iub-plans-v8';
  const STORAGE_THEME = 'iub-theme';

  // New: IRAS auth + source keys
  const IRAS_AUTH_KEY = 'iras-auth-v1';
  const IRAS_SOURCE_KEY = 'source-mode-v1'; // 'iras' | 'static'
  const IRAS_OFFERS_CACHE_PREFIX = 'iras-offers-';
  const IRAS_API_URL = 'https://iras-bridge.vercel.app/api/iras-offers';

  // IUB discrete time slots
  const SLOTS = [
    { start: 8*60,        end: 9*60+30,  label: '08:00-09:30' },
    { start: 9*60+40,     end: 11*60+10, label: '09:40-11:10' },
    { start: 11*60+20,    end: 12*60+50, label: '11:20-12:50' },
    { start: 13*60,       end: 14*60+30, label: '13:00-14:30' },
    { start: 14*60+40,    end: 16*60+10, label: '14:40-16:10' },
    { start: 16*60+20,    end: 17*60+50, label: '16:20-17:50' },
  ];
  const SLOT_HEIGHT = 100;
  const HEADER_OFFSET = 24;
  const DAY_GROUPS = { ST: ['S','T'], MW: ['M','W'], AR: ['A','R'] };

  // ---------- State ----------
  let staticSections = [];  // from data/courses.json
  let irasSections = [];    // from IRAS API
  let sourceMode = localStorage.getItem(IRAS_SOURCE_KEY) || 'static';
  let plans = [];    // [{id,name,items:[sectionKey]}]
  let activePlanId = null;
  const sectionByKey = new Map();
  let activeMobileDay = 'S';
  const mql = window.matchMedia('(max-width: 768px)');
  let isMobile = mql.matches;
  let authPopup = null;

  // ---------- Utilities ----------
  const $ = sel => document.querySelector(sel);
  function minutesFromHHMM(s) {
    if (!s) return null;
    let t = String(s).trim();
    t = t.replace(/[^0-9]/g, '');
    if (t.length === 3) t = '0' + t; // "900" -> "0900"
    const m = t.match(/^(\d{2})(\d{2})$/);
    if (!m) return null;
    return parseInt(m[1],10)*60 + parseInt(m[2],10);
  }
  function parseDaysTime(str) {
    const src = (str || '').toString().trim();
    const m = src.match(/^([A-Z]+)\s*:?\s*(\d{3,4})\s*-\s*(\d{3,4})$/i);
    if (!m) return null;
    const rawDays = (m[1] || '').trim().toUpperCase();
    const dayCodes = rawDays.split('').filter(d => DAY_KEYS.includes(d));
    const start = minutesFromHHMM(m[2]);
    const end = minutesFromHHMM(m[3]);
    if (!dayCodes.length || start == null || end == null) return null;
    return { days: dayCodes, start, end, label: `${rawDays}: ${String(m[2]).padStart(4,'0')}-${String(m[3]).padStart(4,'0')}` };
  }
  function keyOf(sec) {
    return `${sec.course}|${sec.section}|${sec.timing.label}|${(sec.faculty||'').trim()}`;
  }
  function saveAll() {
    localStorage.setItem(STORAGE_PLANS, JSON.stringify({ plans, activePlanId }));
  }
  function loadAll() {
    try {
      const p = JSON.parse(localStorage.getItem(STORAGE_PLANS) || '{}');
      if (Array.isArray(p.plans)) plans = p.plans;
      if (p.activePlanId) activePlanId = p.activePlanId;
    } catch {}
    if (!Array.isArray(plans) || plans.length === 0) {
      const id = 'p_' + Math.random().toString(36).slice(2);
      plans = [{ id, name: 'Plan A', items: [] }];
      activePlanId = id;
      saveAll();
    }
  }
  function updateThemeMeta(theme) {
    const meta = document.querySelector('meta[name="theme-color"]');
    if (meta) meta.setAttribute('content', theme === 'light' ? '#ffffff' : '#121821');
  }
  function applyThemeOnLoad() {
    const saved = localStorage.getItem(STORAGE_THEME);
    const theme = saved === 'light' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', theme);
    updateThemeMeta(theme);
    syncThemeButton(theme);
  }
  function setTheme(isLight) {
    const theme = isLight ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem(STORAGE_THEME, theme);
    updateThemeMeta(theme);
    syncThemeButton(theme);
  }
  function syncThemeButton(theme) {
    const btn = $('#themeToggleBtn');
    if (!btn) return;
    const isLight = theme === 'light';
    btn.setAttribute('aria-label', isLight ? 'Switch to dark theme' : 'Switch to light theme');
  }
  function reindexAll() {
    sectionByKey.clear();
    for (const sec of staticSections) sectionByKey.set(keyOf(sec), sec);
    for (const sec of irasSections) sectionByKey.set(keyOf(sec), sec);
  }
  function overlaps(a, b) { return a.start < b.end && b.start < a.end; }
  function findConflictingWith(items, candidate) {
    for (const s of items) {
      const daySet = new Set(s.timing.days);
      if (!candidate.timing.days.some(d => daySet.has(d))) continue;
      if (overlaps({start:s.timing.start, end:s.timing.end}, {start:candidate.timing.start, end:candidate.timing.end})) return s;
    }
    return null;
  }
  function seatStatus(sec) {
    const open = Math.max(sec.capacity - sec.enrolled, 0);
    return { open, full: open === 0 };
  }
  function showToast(msg) {
    const t = $('#toast'); t.textContent = msg; t.classList.add('show');
    clearTimeout(showToast._timer); showToast._timer = setTimeout(()=>t.classList.remove('show'), 2800);
  }
  function slotIndexFor(start, end) {
    for (let i=0;i<SLOTS.length;i++) if (SLOTS[i].start===start && SLOTS[i].end===end) return i;
    return -1;
  }
  function inDayGroup(sec, groupKey) {
    const group = DAY_GROUPS[groupKey]; if (!group) return true;
    return sec.timing.days.some(d => group.includes(d));
  }

  // ---------- IRAS Auth ----------
  function buildRedirectURI() {
    // Return to the same path to keep origin consistent for postMessage
    return window.location.origin + window.location.pathname;
  }
  function getIRASAuth() {
    try { return JSON.parse(localStorage.getItem(IRAS_AUTH_KEY) || 'null'); } catch { return null; }
  }
  function setIRASAuth(auth) {
    localStorage.setItem(IRAS_AUTH_KEY, JSON.stringify(auth));
  }
  function clearIRASAuth() {
    localStorage.removeItem(IRAS_AUTH_KEY);
  }
  function captureIRASAuthFromURL() {
    // If this window was opened as a popup and has auth params, send them to opener then close.
    const url = new URL(window.location.href);
    const qp = url.searchParams;
    const token = qp.get('token');
    const studentId = qp.get('studentId');
    if (token && studentId) {
      const auth = {
        token,
        studentId,
        studentName: qp.get('studentName') || '',
        departmentName: qp.get('departmentName') || '',
        degreeName: qp.get('degreeName') || '',
        email: qp.get('email') || '',
        ts: Date.now()
      };
      // If popup -> post to opener
      if (window.opener && typeof window.opener.postMessage === 'function') {
        window.opener.postMessage({ type: 'IRAS_AUTH', payload: auth }, window.location.origin);
        window.close();
        return true;
      }
      // Fallback: store locally (full-page redirect case)
      setIRASAuth(auth);
      localStorage.setItem(IRAS_SOURCE_KEY, 'iras');
      sourceMode = 'iras';
      // Clean URL
      ['token','studentId','studentName','departmentName','degreeName','email'].forEach(k => qp.delete(k));
      history.replaceState({}, document.title, url.pathname + (qp.toString() ? '?' + qp.toString() : '') + url.hash);
      return true;
    }
    return false;
  }
  function openIRASPopup() {
    const redirect = buildRedirectURI();
    const url = `https://iras-auth.pages.dev/login?redirect_uri=${encodeURIComponent(redirect)}`;
    const w = 520, h = 640;
    const y = window.top.outerHeight / 2 + window.top.screenY - (h / 2);
    const x = window.top.outerWidth / 2 + window.top.screenX - (w / 2);
    authPopup = window.open(url, 'iras_login', `width=${w},height=${h},left=${x},top=${y},resizable=yes,scrollbars=yes`);
    if (!authPopup) {
      // Popup blocked: fallback to full-page
      window.location.href = url;
    }
  }
  function logoutIRAS() {
    clearIRASAuth();
    localStorage.setItem(IRAS_SOURCE_KEY, 'static');
    sourceMode = 'static';
    updateAuthUI();
    renderAll();
  }
  function updateAuthUI() {
    const auth = getIRASAuth();
    const headLogin = $('#btnIRASLoginHeader');
    const deskLogin = $('#btnIRASLoginDesk');
    const info = $('#authInfo');
    const chip = $('#authChip');
    const src = $('#sourceToggle');

    if (auth?.studentId) {
      headLogin.style.display = 'none';
      if (deskLogin) deskLogin.style.display = 'none';
      info.style.display = 'flex';
      chip.textContent = `${auth.studentName || 'Student'} (${auth.studentId})`;
      src.style.display = 'flex';
      // Initialize toggle selection
      const m = localStorage.getItem(IRAS_SOURCE_KEY) || 'iras';
      sourceMode = m;
      $('#srcIras').checked = m === 'iras';
      $('#srcStatic').checked = m === 'static';
    } else {
      info.style.display = 'none';
      const isDesk = window.matchMedia('(min-width: 769px)').matches;
      headLogin.style.display = isDesk ? 'none' : '';
      if (deskLogin) deskLogin.style.display = isDesk ? '' : 'none';
      $('#sourceToggle').style.display = 'none';
      sourceMode = 'static';
      localStorage.setItem(IRAS_SOURCE_KEY, 'static');
    }
  }

  // Receive auth from popup
  window.addEventListener('message', (event) => {
    if (event.origin !== window.location.origin) return;
    if (event.data && event.data.type === 'IRAS_AUTH') {
      const auth = event.data.payload;
      setIRASAuth(auth);
      localStorage.setItem(IRAS_SOURCE_KEY, 'iras');
      sourceMode = 'iras';
      updateAuthUI();
      loadSectionsFromIRAS().then(() => renderAll());
      try { if (authPopup && !authPopup.closed) authPopup.close(); } catch {}
    }
  });

  // ---------- Backend load ----------
  async function loadSectionsFromBackend() {
    const tbody = $('#courseTbody'); const errorBox = $('#courseError');
    try {
      const resp = await fetch('data/courses.json', { cache: 'no-store' });
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const data = await resp.json();
      staticSections = (data || []).map(mapStaticRow).filter(Boolean);
      reindexAll(); errorBox.style.display = 'none';
    } catch (e) {
      staticSections = []; reindexAll();
      errorBox.textContent = 'Failed to load courses. Please try again later.';
      errorBox.style.display = 'block';
      if (tbody) tbody.innerHTML = '<tr><td colspan="7" class="small">No courses available.</td></tr>';
    }
  }
  function mapStaticRow(row) {
    const tParsed = parseDaysTime(row.days_time);
    if (!tParsed) return null;
    return {
      course: row.course || 'UNKNOWN',
      section: parseInt(row.section || '0', 10) || 0,
      title: row.title || '',
      faculty: (row.faculty || '').toString(),
      timing: tParsed,
      enrolled: parseInt(row.enrolled || '0', 10) || 0,
      capacity: parseInt(row.capacity || '0', 10) || 0,
      credits: parseInt(row.credits || '0', 10) || 0,
      cat: row.cat || 'STATIC'
    };
  }

  // ---------- IRAS offers load ----------
  function isCourseLike(o) {
    if (!o || typeof o !== 'object') return false;
    const keys = Object.keys(o);
    const hints = ['course','courseCode','course_code','code','title','faculty','section','sectionNo','days','days_time','start','end'];
    return keys.some(k => hints.includes(k));
  }
  function firstArrayDeep2(obj) {
    // Find a first array of objects within the top 2 levels
    const seen = new Set();
    function scan(x, depth) {
      if (!x || typeof x !== 'object' || seen.has(x) || depth > 2) return null;
      seen.add(x);
      if (Array.isArray(x) && x.length && typeof x[0] === 'object') return x;
      for (const k in x) {
        const v = x[k];
        if (Array.isArray(v) && v.length && typeof v[0] === 'object') return v;
      }
      for (const k in x) {
        const v = x[k];
        const found = scan(v, depth + 1);
        if (found) return found;
      }
      return null;
    }
    return scan(obj, 0);
  }
  function extractOffers(raw) {
    if (Array.isArray(raw)) return raw;
    const candidates = [raw?.data, raw?.response, raw?.payload, raw?.result, raw?.results, raw?.courses, raw?.offerCourses, raw?.offer_courses];
    for (const c of candidates) {
      if (Array.isArray(c)) return c;
      if (c && typeof c === 'object') {
        if (Array.isArray(c.offerCourses)) return c.offerCourses;
        if (Array.isArray(c.offer_courses)) return c.offer_courses;
      }
    }
    const any = firstArrayDeep2(raw);
    return Array.isArray(any) ? any : [];
  }

  async function loadSectionsFromIRAS() {
    const auth = getIRASAuth();
    if (!auth?.studentId || !auth?.token) { irasSections = []; reindexAll(); return; }

    // Try cache first for faster paint
    try {
      const cached = JSON.parse(localStorage.getItem(IRAS_OFFERS_CACHE_PREFIX + auth.studentId) || 'null');
      if (Array.isArray(cached) && cached.length) {
        irasSections = cached.map(mapIRASRow).filter(Boolean);
        reindexAll();
        renderAll();
      }
    } catch {}

    try {
      const response = await fetch(IRAS_API_URL, {
      method: 'POST',
      mode: 'cors',
      cache: 'no-store',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ studentId: auth.studentId, token: auth.token }),
    });

    if (!response.ok) throw new Error('HTTP ' + response.status);
    const raw = await response.json();
    console.log('IRAS offers raw response:', raw);
    const offers = extractOffers(raw);
    localStorage.setItem(IRAS_OFFERS_CACHE_PREFIX + auth.studentId, JSON.stringify(offers));
    irasSections = (offers || []).map(mapIRASRow).filter(Boolean);
    reindexAll();
  } catch (e) {
    console.warn('IRAS offers fetch failed:', e);
  }
}

  // Heuristic mapper for IRAS rows -> internal section object
  function mapIRASRow(c) {
    if (!c) return null;
    const course = c.course || c.courseCode || c.code || c.course_code || c.courseId || 'UNKNOWN';
    const section = parseInt(c.section ?? c.sec ?? c.sectionNo ?? c.section_number ?? c.section_id ?? '0', 10) || 0;
    const title = (c.title ?? c.courseTitle ?? c.name ?? c.course_name ?? '').toString();
    const faculty = (c.faculty ?? c.facultyName ?? c.teacher ?? c.instructor ?? c.teacher_name ?? 'TBA').toString();

    let daysTime =
      c.days_time || c.dayTime || c.daysTime ||
      (function buildDT() {
        const daysRaw = (c.days ?? c.dayCodes ?? c.day ?? c.meetingDays ?? '').toString().replace(/[^ASM TWR]/g,'').replace(/\s+/g,'');
        const start = c.start ?? c.startTime ?? c.timeStart ?? c.from ?? c.slotStart ?? '';
        const end   = c.end   ?? c.endTime   ?? c.timeEnd   ?? c.to   ?? c.slotEnd   ?? '';
        if (!daysRaw || !start || !end) return '';
        const s4 = String(start).replace(/[^0-9]/g,'').padStart(4,'0');
        const e4 = String(end).replace(/[^0-9]/g,'').padStart(4,'0');
        return `${daysRaw}: ${s4}-${e4}`;
      })();

    const timing = parseDaysTime(daysTime);
    if (!timing) return null;

    const capacity = parseInt(c.capacity ?? c.totalSeats ?? c.seats ?? c.max ?? '0', 10) || 0;
    let enrolled = parseInt(c.enrolled ?? c.registered ?? c.taken ?? '0', 10);
    const available = parseInt(c.available ?? c.vacant ?? c.open ?? NaN, 10);
    if (Number.isFinite(available) && capacity) {
      enrolled = Math.max(capacity - available, 0);
    }
    if (!Number.isFinite(enrolled)) enrolled = 0;

    const credits = parseInt(c.credits ?? c.credit ?? '0', 10) || 0;

    return {
      course, section, title, faculty, timing,
      enrolled, capacity, credits,
      cat: 'IRAS'
    };
  }

  // ---------- Rendering ----------
  function getActiveList() {
    // Strict: do not fall back. If IRAS is selected and empty, show message.
    return sourceMode === 'iras' ? irasSections : staticSections;
  }

  function renderPlans() {
    const cont = $('#plans'); cont.innerHTML = '';
    for (const p of plans) {
      const btn = document.createElement('button');
      btn.className = 'plan' + (p.id === activePlanId ? ' active' : '');
      btn.textContent = p.name;
      btn.onclick = () => { activePlanId = p.id; saveAll(); renderAll(); };
      cont.appendChild(btn);
    }
    const plan = plans.find(p => p.id === activePlanId);
    $('#planTitle').textContent = plan ? plan.name : '—';
  }

  function filteredSections() {
    const base = getActiveList();
    const q = ($('#search').value || '').toLowerCase();
    const groupFilter = $('#filterDay').value || '';
    const availFilter = $('#filterAvail').value || '';
    return base.filter(sec => {
      const hay = `${sec.course} ${sec.title} ${sec.faculty}`.toLowerCase();
      if (q && !hay.includes(q)) return false;
      if (groupFilter && !inDayGroup(sec, groupFilter)) return false;
      if (availFilter) {
        const { full } = seatStatus(sec);
        if (availFilter === 'open' && full) return false;
        if (availFilter === 'full' && !full) return false;
      }
      return true;
    });
  }

  function renderCourseTableOrCards() {
    const list = filteredSections();
    const tbody = $('#courseTbody');
    const cards = $('#courseCards');

    // Show message when IRAS selected but no data yet
    if (sourceMode === 'iras' && irasSections.length === 0) {
      $('#tableWrap').style.display = isMobile ? 'none' : '';
      cards.style.display = isMobile ? 'grid' : 'none';
      if (!isMobile) {
        tbody.innerHTML = '<tr><td colspan="7" class="small">No IRAS courses to show yet. Sign in via IRAS or wait for data to load. See Console for “IRAS offers raw response”.</td></tr>';
      } else {
        cards.innerHTML = '<div class="small" style="padding:8px;">No IRAS courses to show yet.</div>';
      }
      return;
    }

    if (!isMobile) {
      // Desktop: table
      $('#tableWrap').style.display = '';
      cards.style.display = 'none';
      tbody.innerHTML = '';
      const active = plans.find(p => p.id === activePlanId);

      for (const sec of list) {
        const tr = document.createElement('tr');
        const { open, full } = seatStatus(sec);

        tr.innerHTML = `
          <td class="nowrap"><strong>${sec.course}</strong></td>
          <td>${sec.section}</td>
          <td><span class="tag">${sec.timing.label}</span></td>
          <td class="wrap"></td>
          <td class="wrap">${sec.title || ''}</td>
          <td class="right"><span class="avail ${full ? 'full' : 'ok'}">${open}/${sec.capacity}</span></td>
          <td class="actions"></td>
        `;
        tr.children[3].textContent = sec.faculty || '';

        const actions = tr.querySelector('.actions');
        const btnAdd = document.createElement('button');
        btnAdd.className = 'btn';
        btnAdd.textContent = 'Add To Plan';
        btnAdd.onclick = () => tryAddToPlan(sec, active);
        actions.appendChild(btnAdd);

        tbody.appendChild(tr);
      }
    } else {
      // Mobile: cards
      $('#tableWrap').style.display = 'none';
      cards.style.display = 'grid';
      cards.innerHTML = '';
      const active = plans.find(p => p.id === activePlanId);

      for (const sec of list) {
        const { open, full } = seatStatus(sec);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-top">
            <div class="card-title">${sec.course} • Sec ${sec.section}</div>
            <div class="tag">${sec.timing.label}</div>
          </div>
          <div class="card-sub">${sec.title || ''}</div>
          <div class="card-meta">
            <span class="small"><strong>Faculty:</strong> <span class="fac"></span></span>
            <span class="small"><strong>Seats:</strong> <span class="${full ? 'avail full' : 'avail ok'}">${open}/${sec.capacity}</span></span>
          </div>
          <div class="card-actions">
            <button class="btn">Add To Plan</button>
          </div>
        `;
        card.querySelector('.fac').textContent = sec.faculty || '';
        card.querySelector('.btn').onclick = () => tryAddToPlan(sec, active);
        cards.appendChild(card);
      }
    }
  }

  function tryAddToPlan(sec, active) {
    if (!active) return showToast('Create and select a plan first.');
    const existingItems = active.items.map(k => sectionByKey.get(k)).filter(Boolean);
    if (existingItems.some(x => x.course === sec.course)) {
      showToast(`You can't choose two sections of the same course (${sec.course}). Remove the other section first.`);
      return;
    }
    const conflict = findConflictingWith(existingItems, sec);
    if (conflict) {
      showToast(`Cannot add: ${sec.course} Sec-${sec.section} (${sec.timing.label}) conflicts with ${conflict.course} Sec-${conflict.section} (${conflict.timing.label}).`);
      return;
    }
    const k = keyOf(sec);
    if (!active.items.includes(k)) active.items.push(k);
    saveAll(); renderAll();
  }

  function renderSchedule() {
    const sched = $('#schedule');
    const mSched = $('#mSchedule');
    const plan = plans.find(p => p.id === activePlanId);
    const items = (plan?.items || []).map(k => sectionByKey.get(k)).filter(Boolean);

    if (!isMobile) {
      $('#dayTabs').style.display = 'none';
      mSched.style.display = 'none';
      sched.style.display = 'block';
      sched.innerHTML = '';

      sched.style.height = (HEADER_OFFSET + SLOTS.length * SLOT_HEIGHT) + 'px';

      const slots = document.createElement('div');
      slots.className = 'slots';
      const slotsHeader = document.createElement('div');
      slotsHeader.className = 'slots-header';
      slots.appendChild(slotsHeader);
      for (let i=0;i<SLOTS.length;i++) {
        const row = document.createElement('div');
        row.className = 'slot';
        row.style.top = `${HEADER_OFFSET + i*SLOT_HEIGHT}px`;
        row.style.height = `${SLOT_HEIGHT}px`;
        row.textContent = SLOTS[i].label;
        slots.appendChild(row);
      }
      sched.appendChild(slots);

      const days = document.createElement('div');
      days.className = 'days';
      for (let d = 0; d < DAY_KEYS.length; d++) {
        const col = document.createElement('div');
        col.className = 'day-col';
        const header = document.createElement('div');
        header.className = 'day-header';
        const dk = DAY_KEYS[d];
        header.innerHTML = `<strong>${DAY_NAME_MAP[dk]}</strong>`;
        col.appendChild(header);
        for (let i=0;i<SLOTS.length;i++) {
          const line = document.createElement('div');
          line.style.position = 'absolute';
          line.style.left = '0'; line.style.right = '0';
          line.style.top = `${HEADER_OFFSET + i*SLOT_HEIGHT}px`;
          line.style.borderTop = '1px dashed var(--grid-line)';
          col.appendChild(line);
        }
        days.appendChild(col);
      }
      sched.appendChild(days);

      for (const sec of items) {
        const idx = slotIndexFor(sec.timing.start, sec.timing.end);
        const top = (idx >= 0 ? HEADER_OFFSET + idx * SLOT_HEIGHT + 6 : HEADER_OFFSET + 6);
        const height = (idx >= 0 ? SLOT_HEIGHT - 12 : SLOT_HEIGHT - 12);
        for (const d of sec.timing.days) {
          const dayIdx = DAY_MAP[d];
          const block = document.createElement('div');
          block.className = 'block';
          block.style.top = `${top}px`;
          block.style.height = `${height}px`;
          block.innerHTML = `
            <div><strong>${sec.course}</strong> Sec ${sec.section}</div>
            <div class="small">${sec.timing.label} • ${sec.title || ''}</div>
            <div class="small"></div>
          `;
          block.querySelector('.small:last-child').textContent = sec.faculty || '';
          const dayCol = sched.querySelector('.days').children[dayIdx];
          block.style.left = '6px';
          block.style.right = '6px';
          dayCol.appendChild(block);
        }
      }
    } else {
      $('#dayTabs').style.display = 'flex';
      sched.style.display = 'none';
      mSched.style.display = 'block';
      mSched.innerHTML = '';

      if (!DAY_KEYS.includes(activeMobileDay)) activeMobileDay = DAY_KEYS[0];

      const tabs = $('#dayTabs');
      tabs.innerHTML = '';
      for (const dk of DAY_KEYS) {
        const tab = document.createElement('button');
        tab.className = 'day-tab' + (dk === activeMobileDay ? ' active' : '');
        tab.textContent = DAY_NAME_MAP[dk];
        tab.onclick = () => { activeMobileDay = dk; renderSchedule(); };
        tabs.appendChild(tab);
      }

      for (let i=0; i<SLOTS.length; i++) {
        const slot = SLOTS[i];
        const row = document.createElement('div');
        row.className = 'm-slot';
        const label = document.createElement('div');
        label.className = 'm-slot-label';
        label.textContent = slot.label;
        row.appendChild(label);

        const inThisSlot = items.filter(s =>
          s.timing.days.includes(activeMobileDay) &&
          s.timing.start === slot.start &&
          s.timing.end === slot.end
        );

        if (inThisSlot.length === 0) {
          const none = document.createElement('div');
          none.className = 'small';
          none.textContent = '—';
          row.appendChild(none);
        } else {
          for (const sec of inThisSlot) {
            const card = document.createElement('div');
            card.className = 'm-block';
            card.innerHTML = `
              <div><strong>${sec.course}</strong> Sec ${sec.section}</div>
              <div class="small">${sec.title || ''}</div>
              <div class="small"></div>
            `;
            card.querySelector('.small:last-child').textContent = sec.faculty || '';
            row.appendChild(card);
          }
        }

        mSched.appendChild(row);
      }
    }
  }

  function renderPlanList() {
    const plan = plans.find(p => p.id === activePlanId);
    const items = (plan?.items || []).map(k => sectionByKey.get(k)).filter(Boolean);
    const list = $('#planList');
    list.innerHTML = '';
    for (const sec of items) {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="wrap">
          <strong>${sec.course}</strong> Sec ${sec.section}
          <span class="tag">${sec.timing.label}</span>
          <div class="small">${sec.title}</div>
          <div class="small"></div>
        </div>
      `;
      div.querySelector('.small:last-child').textContent = sec.faculty || '';
      const r = document.createElement('div');
      const btn = document.createElement('button');
      btn.className = 'btn danger';
      btn.textContent = 'Remove';
      btn.onclick = () => {
        const k = keyOf(sec);
        plan.items = plan.items.filter(x => x !== k);
        saveAll(); renderAll();
      };
      r.appendChild(btn);
      div.appendChild(r);
      list.appendChild(div);
    }
  }

  function renderAll() {
    updateAuthUI(); // update source toggle visibility/selection
    renderPlans();
    renderCourseTableOrCards();
    renderSchedule();
    renderPlanList();
  }

  // ---------- Header compact behavior (mobile) ----------
  const headerEl = $('#appHeader');
  function updateHeaderCompact() {
    if (!headerEl) return;
    const shouldCompact = isMobile && window.scrollY > 20;
    headerEl.classList.toggle('compact', shouldCompact);
  }
  window.addEventListener('scroll', updateHeaderCompact, { passive: true });

  // ---------- Filters bottom sheet handlers (mobile) ----------
  function closeFiltersSheet() {
    const wrap = document.getElementById('filtersWrap');
    const bd = document.getElementById('filtersBackdrop');
    const btn = document.getElementById('btnToggleFilters');
    if (!wrap || !bd) return;
    wrap.classList.remove('open');
    bd.classList.remove('show');
    if (btn) btn.setAttribute('aria-expanded', 'false');
  }

  document.getElementById('btnToggleFilters').onclick = () => {
    const wrap = document.getElementById('filtersWrap');
    const bd = document.getElementById('filtersBackdrop');
    const open = !wrap.classList.contains('open');
    wrap.classList.toggle('open', open);
    bd.classList.toggle('show', open);
    document.getElementById('btnToggleFilters')
      .setAttribute('aria-expanded', open ? 'true' : 'false');
  };

  // When backdrop is tapped: close, then re-dispatch the tap to what's underneath
  document.getElementById('filtersBackdrop').addEventListener('click', (e) => {
    const { clientX, clientY } = e;
    closeFiltersSheet();
    requestAnimationFrame(() => {
      const el = document.elementFromPoint(clientX, clientY);
      if (el && typeof el.click === 'function') el.click();
    });
  });

  document.getElementById('btnCloseFilters').onclick = () => closeFiltersSheet();

  // Safety: any interaction with the Plans panel closes the sheet first
  document.getElementById('planPanel').addEventListener('pointerdown', () => closeFiltersSheet());

  // ---------- Events ----------
  $('#btnQuickAddPlan').onclick = () => {
    const id = 'p_' + Math.random().toString(36).slice(2);
    plans.push({ id, name: `Plan ${String.fromCharCode(65 + plans.length)}`, items: [] });
    activePlanId = id;
    saveAll(); renderAll();
    showToast('New plan created.');
  };

  $('#btnAddPlan').onclick = () => {
    const base = ($('#newPlanName').value || '').trim();
    const name = base || `Plan ${String.fromCharCode(65 + plans.length)}`;
    const id = 'p_' + Math.random().toString(36).slice(2);
    plans.push({ id, name, items: [] });
    activePlanId = id;
    $('#newPlanName').value = '';
    saveAll(); renderAll();
  };

  $('#btnRenamePlan').onclick = () => {
    const p = plans.find(x => x.id === activePlanId);
    if (!p) return showToast('No active plan.');
    const name = prompt('New name:', p.name);
    if (!name) return;
    p.name = name;
    saveAll(); renderAll();
  };

  $('#btnDuplicatePlan').onclick = () => {
    const p = plans.find(x => x.id === activePlanId);
    if (!p) return showToast('No active plan.');
    const id = 'p_' + Math.random().toString(36).slice(2);
    plans.push({ id, name: p.name + ' (copy)', items: [...p.items] });
    activePlanId = id;
    saveAll(); renderAll();
  };

  $('#btnDeletePlan').onclick = () => {
    const idx = plans.findIndex(x => x.id === activePlanId);
    if (idx < 0) return showToast('No active plan.');
    const ok = confirm(`Delete ${plans[idx].name}?`);
    if (!ok) return;
    plans.splice(idx, 1);
    activePlanId = plans[0]?.id || null;
    saveAll(); renderAll();
  };

  $('#btnClearActive').onclick = () => {
    const p = plans.find(x => x.id === activePlanId);
    if (!p) return;
    p.items = [];
    saveAll(); renderAll();
  };

  $('#search').oninput = () => renderCourseTableOrCards();
  $('#filterDay').onchange = () => renderCourseTableOrCards();
  $('#filterAvail').onchange = () => renderCourseTableOrCards();

  // Theme toggle (switch)
  $('#themeToggleBtn').addEventListener('click', () => {
    const current = document.documentElement.getAttribute('data-theme') || 'dark';
    setTheme(current !== 'light');
  });

  // IRAS auth controls
  $('#btnIRASLoginHeader').addEventListener('click', openIRASPopup);
  const deskBtn = document.getElementById('btnIRASLoginDesk');
  if (deskBtn) deskBtn.addEventListener('click', openIRASPopup);
  $('#btnIRASLogout').addEventListener('click', logoutIRAS);

  // Source toggle
  $('#sourceToggle').addEventListener('change', (e) => {
    if (!(e.target instanceof HTMLInputElement)) return;
    const val = e.target.value === 'iras' ? 'iras' : 'static';
    sourceMode = val;
    localStorage.setItem(IRAS_SOURCE_KEY, val);
    renderAll();
  });

  // PWA: register service worker (unchanged)
  (function registerSW() {
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const reg = await navigator.serviceWorker.register('./sw.js');
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            window.location.reload();
          });
        } catch (e) {
          console.warn('SW registration failed:', e);
        }
      });
    }
  })();

  // Mobile breakpoint watcher
  mql.addEventListener('change', e => {
    isMobile = e.matches;
    updateAuthUI();
    updateHeaderCompact();
    renderAll();
  });

  // ---------- Init ----------
  applyThemeOnLoad();
  loadAll();
  const captured = captureIRASAuthFromURL(); // handles popup callback too
  updateAuthUI();
  loadSectionsFromBackend();
  loadSectionsFromIRAS();
  // Initial render once static is in or after short delay
  setTimeout(() => { renderAll(); updateHeaderCompact(); }, 150);
</script>
</body>
</html>
